<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Salesforce Developer Lab Hackathon: Knowledge Companion</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            line-height: 1.6;
            margin: 0;
            padding: 0;
            background-color: #f4f7f9;
            color: #333;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .slide-container {
            width: 90%;
            max-width: 1000px;
            margin: 20px auto;
            background-color: #fff;
            border: 1px solid #ddd;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .slide {
            display: none;
            padding: 30px 40px;
            min-height: 400px;
            animation: fadeIn 0.5s ease-in-out;
        }

        .slide.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        h1, h2, h3, h4 {
            color: #003972; /* Salesforce Blue */
            margin-bottom: 0.75em;
        }
        h1 { font-size: 2.2em; text-align: center; margin-bottom: 1em; color: #001B35; }
        h2 { font-size: 1.8em; border-bottom: 2px solid #00A1E0; padding-bottom: 0.3em; margin-top: 1.5em;}
        h3 { font-size: 1.4em; margin-top: 1.2em; }
        h4 { font-size: 1.1em; font-style: italic; color: #555;}


        p, ul, ol {
            margin-bottom: 1em;
        }

        ul, ol {
            padding-left: 20px;
        }
        li { margin-bottom: 0.5em; }

        code { /* For inline code */
            font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, Courier, monospace;
            background-color: #eef1f3;
            padding: 0.2em 0.4em;
            border-radius: 3px;
            font-size: 0.9em;
        }

        pre { /* For code blocks */
            background-color: #2d2d2d; /* Dark background */
            color: #f8f8f2; /* Light text */
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto; /* Allow horizontal scrolling for long lines */
            font-size: 0.85em; /* Slightly smaller for blocks */
            line-height: 1.5;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            white-space: pre; /* Preserve whitespace and line breaks */
        }
        pre code { /* Reset styles for <code> inside <pre> */
            background-color: transparent;
            padding: 0;
            font-size: 1em; 
            color: inherit; 
            white-space: inherit; 
        }

        .navigation-buttons {
            display: flex;
            justify-content: space-between;
            padding: 20px 40px;
            background-color: #f0f0f0;
            border-top: 1px solid #ccc;
            width: 90%;
            max-width: 1000px;
            box-sizing: border-box;
            margin: 0 auto 20px auto; 
        }

        .navigation-buttons button {
            background-color: #0070d2;
            color: white;
            border: none;
            padding: 10px 20px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .navigation-buttons button:hover:not(:disabled) {
            background-color: #005fb2;
        }

        .navigation-buttons button:disabled {
            background-color: #c0c0c0;
            cursor: not-allowed;
        }

        .note {
            background-color: #fff3cd;
            border-left: 5px solid #ffeeba;
            padding: 10px 15px;
            margin: 15px 0;
            border-radius: 3px;
        }
        .note strong { color: #856404; }

        .modal { 
            display: none; position: fixed; z-index: 1000;
            left: 0; top: 0; width: 100%; height: 100%;
            overflow: auto; background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe; margin: 15% auto; padding: 20px;
            border: 1px solid #888; width: 60%; border-radius: 8px;
            box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2),0 6px 20px 0 rgba(0,0,0,0.19);
        }
        .modal-content h3 { margin-top: 0;}

        #workflowAnimation {
            width: 100%; height: 400px; border: 1px solid #eee;
            margin-top: 20px; background-color: #f9f9f9;
        }
        #workflowAnimation svg { display: block; width: 100%; height: 100%;}

        .summary-toggle-container {
            margin-top: 20px; padding: 15px; background-color: #e9ecef; border-radius: 5px;
        }
        .summary-toggle-container button { margin-bottom: 10px;}
        .summary-text-area {
            border: 1px dashed #ccc; padding: 10px; min-height: 100px; background-color: #fff;
        }
        #summaryAfterView { display: none; }
    </style>
</head>
<body>

    <h1>üöÄ Salesforce Developer Lab: Knowledge Companion - Document Summariser üìÑ</h1>

    <div class="slide-container">
        <div class="slide active" id="slide1">
            <h2>Lab Overview & Business Impact</h2>
            <h3>The Challenge: Information Overload üò©</h3>
            <p>In today's fast-paced environment, users are often confronted with vast amounts of text. Quickly understanding the essence of long documents like Salesforce <strong>Knowledge Articles</strong>, detailed <strong>Case Descriptions</strong>, or comprehensive <strong>Product Manuals</strong> is crucial but time-consuming.</p>
            <h3>The Solution: Knowledge Companion ‚ú®</h3>
            <p>This lab guides you in building a "Knowledge Companion" tool. Powered by the <strong>Gemini API</strong> (using the Gemini Flash 1.5 model), this tool integrates directly into Salesforce to provide instant summaries of lengthy text content. This significantly enhances productivity by allowing users to grasp key information at a glance.</p>
            <h3>Real-Life Use Cases üí°</h3>
            <ul>
                <li><strong>Support Agents:</strong> Quickly summarize complex case histories or long knowledge articles to resolve issues faster.</li>
                <li><strong>Sales Teams:</strong> Get rapid summaries of account details, past communications, or opportunity notes.</li>
                <li><strong>Product Managers:</strong> Condense user feedback or technical documentation.</li>
                <li><strong>Any Salesforce User:</strong> Efficiently process information from lengthy text fields across various objects.</li>
            </ul>
        </div>

        <div class="slide" id="slide2">
            <h2>Lab Goal üéØ</h2>
            <p>By the end of this lab, you will have built a solution that can:</p>
            <ul>
                <li>Summarize content from a rich text area field (e.g., <code>Content_for_Summarization__c</code>) on a Salesforce Knowledge Article.</li>
                <li>Trigger this summarization process via a custom Lightning Web Component (LWC) button ("AI Summarise") placed on the Knowledge Article page.</li>
                <li>Display the AI-generated summary clearly within a modal dialog on the screen.</li>
                <li><strong>Explore your creativity</strong> in crafting effective prompts to the Gemini API to summarize different types of content in innovative ways.</li>
            </ul>
            <p>This hands-on experience will cover Salesforce configuration, Apex development for API callouts, and LWC creation for a seamless user interface.</p>
        </div>

        <div class="slide" id="slide3">
            <h2>Pre-requisites üõ†Ô∏è</h2>
            <p>Before we begin building, please ensure you have the following:</p>
            <h3>1. Salesforce Developer Org</h3>
            <ul>
                <li>A Salesforce Developer Edition org where you have admin privileges.</li>
                <li>Salesforce Knowledge should be enabled in your org:
                    <ul>
                        <li>Navigate to <strong>Setup</strong> &gt; <strong>Knowledge</strong> &gt; <strong>Knowledge Settings</strong>.</li>
                        <li>If not already enabled, check "Yes, I'd like to enable Salesforce Knowledge" and follow the setup wizard.</li>
                    </ul>
                </li>
                <li>A custom field (e.g., Text Area (Rich) or Text Area (Long)) on the Knowledge Article object (API Name: <code>Knowledge__kav</code>) to hold the content you want to summarize. For example, <code>Content_for_Summarization__c</code>. Note down its API name.</li>
                <li>Your user profile must have "API Enabled" system permission and CRUD permissions for Knowledge articles and your chosen custom field.</li>
            </ul>
            <h3>2. Google Gemini API Key (Provided for this Lab)</h3>
            <ul>
                <li>For this lab, a **common Google Gemini API Key will be provided to you** by the instructors.
                <li>You will use this provided key directly in the Apex code.</li>
            </ul>
            <h3>3. Basic Familiarity (Helpful but not strictly required)</h3>
            <ul>
                <li>Basic understanding of Salesforce Apex.</li>
                <li>Basic understanding of Lightning Web Components (HTML, JavaScript).</li>
            </ul>
        </div>

        <div class="slide" id="slide4">
            <h2>Lab Step 1: Gemini API Configuration (Using Provided Key) üîë</h2>
            <p>For this lab, we will simplify the API key setup by using a common key provided by your instructors directly in the Apex code.</p>
            
            <h3>1. Understanding API Key Usage in this Lab</h3>
            <ul>
                <li>You will receive a Gemini API Key from the lab instructors.</li>
                <li>You will insert this key directly into a placeholder in the Apex class we create in the next step.</li>
                <li>The Apex code will construct the API endpoint URL and include this key for authentication.</li>
            </ul>

            <h3>2. Important Note: API Key in Endpoint vs. Named Credentials (Best Practice)</h3>
            <div class="note">
                <p><strong>For Lab Simplicity:</strong> We are putting the API key directly into the Apex code and potentially into the endpoint URL construction. This makes the lab setup quicker for everyone using a shared key.</p>
                <p><strong>‚ö†Ô∏è Security Best Practice (for your future projects & production): DO NOT hardcode API keys or include them directly in endpoint URLs in your code.</strong></p>
                <ul>
                    <li>The **recommended approach in Salesforce is to use Named Credentials**. Named Credentials securely store the endpoint URL and handle authentication details (like API keys, typically placed in custom headers or managed via other authentication flows) separately from your code.</li>
                    <li>Another secure method is to store keys in **Protected Custom Settings/Metadata** and retrieve them in Apex.</li>
                </ul>
                <p>We will add an appendix slide at the end of this deck showing how to get your own API key and how to set up Named Credentials for your future reference.</p>
            </div>
            <p>In the next step, when we write the Apex code, you'll see where to place the provided API key.</p>
        </div>

        <div class="slide" id="slide5">
            <h2>Lab Step 2: Apex Code Walkthrough üë®‚Äçüíª</h2>
            <p>This Apex class (<code>GeminiAPIService.cls</code>) will make the callout to the Gemini API using the provided API key.</p>
            <p><strong>Action:</strong> Create this Apex class in your Salesforce org.</p>
            <pre><code class="language-apex">
// File: GeminiAPIService.cls
// Purpose: Service class to interact with the Google Gemini API for text summarization.
public with sharing class GeminiAPIService {

    // Retrieves the Gemini API Key.
    // FOR LAB PURPOSES: Replace the placeholder string with the API key provided by your instructor.
    private static String getProvidedApiKey() {
        // TODO: LAB PARTICIPANT - REPLACE 'KEY_PROVIDED_BY_INSTRUCTOR' WITH THE ACTUAL API KEY.
        String apiKey = 'KEY_PROVIDED_BY_INSTRUCTOR'; 

        if (String.isBlank(apiKey) || apiKey == 'KEY_PROVIDED_BY_INSTRUCTOR') {
            System.debug(LoggingLevel.ERROR, 'GeminiAPIService.getProvidedApiKey(): API Key is missing or is still the placeholder. Please update it with the key from your instructor.');
        }
        return apiKey;
    }

    @AuraEnabled(cacheable=false) 
    public static String getPageSummaryFromGemini(String htmlText) {
        String textToSummarize = htmlText;

        if (String.isBlank(textToSummarize)) {
            System.debug('GeminiAPIService.getPageSummaryFromGemini: Input text was blank.');
            return 'Error: Input text for summarization is blank.';
        }
        
        String GEMINI_API_KEY = getProvidedApiKey();

        if (String.isBlank(GEMINI_API_KEY) || GEMINI_API_KEY == 'KEY_PROVIDED_BY_INSTRUCTOR') {
            return 'Error: The provided Gemini API Key is not configured in Apex. Please update GeminiAPIService.cls.';
        }

        // Constructing the endpoint with the API key as a query parameter for lab simplicity.
        // NOTE FOR PRODUCTION: For POST requests with a body, Gemini API typically prefers the 
        // API key in the 'x-goog-api-key' header. Using Named Credentials would abstract this.
        String endpoint = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=' + GEMINI_API_KEY;

        String prompt = 'You are an AI assistant trained to summarize web content into a short, well-structured, HTML-formatted summary. ' +
            'The input includes raw visible text from an internal Salesforce Experience Cloud page. ' +
            'Please ignore navigation menus, headers, footers, search bars, and unrelated UI text. ' +
            'Focus only on meaningful main content such as policy text, announcements, structured descriptions, and business explanations.\n\n' +
            'Provide your output in HTML format using bullet points (i.e., use &lt;ul&gt;&lt;li&gt;...&lt;/li&gt;&lt;/ul&gt;) when possible. ' +
            'Avoid repeating text or adding boilerplate language.\n\n' +
            'Here is the extracted page text:\n\n' + textToSummarize;

        Map&lt;String, Object&gt; requestBody = new Map&lt;String, Object&gt;{
            'contents' => new List&lt;Object&gt;{
                new Map&lt;String, Object&gt;{
                    'parts' => new List&lt;Object&gt;{
                        new Map&lt;String, Object&gt;{
                            'text' => prompt
                        }
                    }
                }
            }
        };

        HttpRequest req = new HttpRequest();
        req.setEndpoint(endpoint); 
        req.setMethod('POST');
        req.setHeader('Content-Type', 'application/json; charset=utf-8');
        // If key is in URL, x-goog-api-key header might not be strictly needed, but often good practice to include if API supports both.
        // For this lab version with key in URL, we can omit it here.
        // req.setHeader('x-goog-api-key', GEMINI_API_KEY); 
        req.setTimeout(60000); 
        req.setBody(JSON.serialize(requestBody));

        Http http = new Http();
        String summaryResult = '';

        try {
            HttpResponse res = http.send(req);
            System.debug('Gemini API Callout Status: ' + res.getStatusCode() + ', Body: ' + res.getBody());

            if (res.getStatusCode() == 200) {
                Map&lt;String, Object&gt; jsonResponse = (Map&lt;String, Object&gt;) JSON.deserializeUntyped(res.getBody());
                List&lt;Object&gt; candidates = (List&lt;Object&gt;) jsonResponse.get('candidates');
                
                if (candidates != null && !candidates.isEmpty()) {
                    Map&lt;String, Object&gt; firstCandidate = (Map&lt;String, Object&gt;) candidates[0];
                    Map&lt;String, Object&gt; content = (Map&lt;String, Object&gt;) firstCandidate.get('content');
                    if (content != null) {
                        List&lt;Object&gt; parts = (List&lt;Object&gt;) content.get('parts');
                        if (parts != null && !parts.isEmpty()) {
                            Map&lt;String, Object&gt; part = (Map&lt;String, Object&gt;) parts[0];
                            summaryResult = (String) part.get('text');
                        } else { summaryResult = 'Error: No "parts" in API response content.'; }
                    } else { summaryResult = 'Error: No "content" in API response candidate.'; }
                } else { 
                    summaryResult = 'Error: No "candidates" in API response.';
                    if (jsonResponse.containsKey('error')) {
                        Map&lt;String, Object&gt; errorDetails = (Map&lt;String, Object&gt;)jsonResponse.get('error');
                        summaryResult += ' API Error: ' + String.valueOf(errorDetails.get('message'));
                    }
                }
            } else {
                summaryResult = 'Error from Gemini API: Status ' + res.getStatusCode() + '. Response: ' + res.getBody();
            }
        } catch (System.CalloutException cex) {
            summaryResult = 'Error: Callout exception - ' + cex.getMessage();
            System.debug(LoggingLevel.ERROR, 'GeminiAPIService CalloutException: ' + cex.getMessage() + '\\n' + cex.getStackTraceString());
        } catch (Exception ex) {
            summaryResult = 'Error: Exception during Gemini API callout - ' + ex.getMessage();
            System.debug(LoggingLevel.ERROR, 'GeminiAPIService Generic Exception: ' + ex.getMessage() + '\\n' + ex.getStackTraceString());
        }
        return summaryResult;
    }
}
</code></pre>
            <div class="note">
                <strong>Action:</strong>
                <ol>
                    <li>Copy the Apex code above.</li>
                    <li>In Salesforce Setup, go to Developer Console and create a new Apex Class named <code>GeminiAPIService</code>.</li>
                    <li>Paste the code and **replace <code>'KEY_PROVIDED_BY_INSTRUCTOR'</code>** with the valid Gemini API Key provided during the lab.</li>
                    <li>Save the class.</li>
                    <li><strong>Comment on Named Credentials:</strong> For production, you would typically use a Named Credential. The endpoint in Apex would then be <code>'callout:Your_Named_Credential_Name/v1beta/models/gemini-1.5-flash:generateContent'</code> and the API key would be handled by the Named Credential setup (often as a custom header) or retrieved from a secure custom setting and added as a header in Apex, rather than being part of the endpoint URL string.</li>
                </ol>
            </div>
        </div>

        <div class="slide" id="slide6">
            <h2>Lab Step 3: Lightning Web Component (LWC) ‚ö°</h2>
            <p>Create an LWC named <code>knowledgeCompanion</code> (or similar). This LWC will call the Apex method.</p>
            <p>We'll show two versions of the LWC:
                <br>A) Summarizing a specific field from a Knowledge Article (original lab goal).
                <br>B) Summarizing the entire page's text (based on LWC code you previously shared).
                <br>Choose the version that best fits your lab's focus.
            </p>

            <h3>Version A: Summarizing a Specific Record Field</h3>
            <p>This is best if your LWC is on a specific record page (like Knowledge__kav) and you want to summarize a field from that record.</p>
            <h4>1. <code>knowledgeCompanion.html</code> (Version A)</h4>
            <pre><code class="language-html">
&lt;!-- File: knowledgeCompanion.html --&gt;
&lt;template&gt;
    &lt;lightning-card title="Knowledge Article Summarizer" icon-name="utility:summarydetail"&gt;
        &lt;div class="slds-p-around_medium"&gt;
            &lt;lightning-button
                label="Summarise Article Content"
                variant="brand"
                onclick={handleSummarizeArticleField}
                disabled={isLoading}
                icon-name="utility:magicwand"&gt;
            &lt;/lightning-button&gt;
            &lt;template if:true={isLoading}&gt;
                &lt;div class="slds-m-top_medium slds-is-relative" style="height: 50px;"&gt;
                    &lt;lightning-spinner alternative-text="Loading summary..." size="medium"&gt;&lt;/lightning-spinner&gt;
                &lt;/div&gt;
            &lt;/template&gt;
            &lt;template if:true={error}&gt;
                &lt;div class="slds-m-top_medium slds-text-color_error"&gt;&lt;p&gt;&lt;strong&gt;Error:&lt;/strong&gt; {error}&lt;/p&gt;&lt;/div&gt;
            &lt;/template&gt;
        &lt;/div&gt;
    &lt;/lightning-card&gt;
    &lt;template if:true={isModalOpen}&gt;
        &lt;section role="dialog" tabindex="-1" aria-modal="true" class="slds-modal slds-fade-in-open"&gt;
            &lt;div class="slds-modal__container"&gt;
                &lt;header class="slds-modal__header"&gt;
                    &lt;button class="slds-button slds-button_icon slds-modal__close slds-button_icon-inverse" title="Close" onclick={closeModal}&gt;
                        &lt;lightning-icon icon-name="utility:close" alternative-text="Close" variant="inverse" size="small"&gt;&lt;/lightning-icon&gt;
                    &lt;/button&gt;
                    &lt;h2 class="slds-modal__title slds-hyphenate"&gt;Article Summary&lt;/h2&gt;
                &lt;/header&gt;
                &lt;div class="slds-modal__content slds-p-around_medium"&gt;
                    &lt;lightning-formatted-rich-text value={summaryText}&gt;&lt;/lightning-formatted-rich-text&gt;
                &lt;/div&gt;
                &lt;footer class="slds-modal__footer"&gt;&lt;lightning-button label="Close" title="Close" onclick={closeModal}&gt;&lt;/lightning-button&gt;&lt;/footer&gt;
            &lt;/div&gt;
        &lt;/section&gt;
        &lt;div class="slds-backdrop slds-backdrop_open" role="presentation"&gt;&lt;/div&gt;
    &lt;/template&gt;
&lt;/template&gt;
            </code></pre>

            <h4>2. <code>knowledgeCompanion.js</code> (Version A)</h4>
            <pre><code class="language-javascript">
// File: knowledgeCompanion.js (Version A: Summarizing a specific field)
import { LightningElement, api, wire, track } from 'lwc';
import { getRecord, getFieldValue } from 'lightning/uiRecordApi';
import getPageSummaryFromGemini from '@salesforce/apex/GeminiAPIService.getPageSummaryFromGemini';

// TODO: LAB PARTICIPANT - Update this import for YOUR Knowledge Article field.
// Example: import KNOWLEDGE_CONTENT_FIELD from '@salesforce/schema/Knowledge__kav.MyCustomBody__c';
import KNOWLEDGE_CONTENT_FIELD from '@salesforce/schema/Knowledge__kav.Content_for_Summarization__c'; 

export default class KnowledgeCompanion extends LightningElement {
    @api recordId;
    @track summaryText = '';
    @track isLoading = false;
    @track error;
    @track isModalOpen = false;
    _wiredArticleData;

    @wire(getRecord, { recordId: '$recordId', fields: [KNOWLEDGE_CONTENT_FIELD] })
    wiredArticle({ error, data }) {
        if (data) {
            this._wiredArticleData = data; this.error = undefined;
        } else if (error) {
            this.error = 'Failed to load article content. Check field API name & permissions.';
            console.error('LWC wire error:', JSON.stringify(error));
        }
    }

    get articleContent() {
        return this._wiredArticleData ? getFieldValue(this._wiredArticleData, KNOWLEDGE_CONTENT_FIELD) : undefined;
    }

    async handleSummarizeArticleField() {
        this.isLoading = true; this.error = undefined; this.summaryText = '';
        const contentValue = this.articleContent;

        if (!contentValue || String(contentValue).trim() === '') {
            this.error = \`Field '\${KNOWLEDGE_CONTENT_FIELD.fieldApiName}' is empty.\`;
            this.isLoading = false; return;
        }
        
        let plainTextContent = this.stripHtml(String(contentValue));
        if (!plainTextContent || plainTextContent.trim() === '') {
            this.error = 'Content empty after HTML stripping.';
            this.isLoading = false; return;
        }

        try {
            const result = await getPageSummaryFromGemini({ htmlText: plainTextContent });
            if (result) {
                if (result.toLowerCase().startsWith('error:')) { this.error = result; } 
                else { this.summaryText = result; this.isModalOpen = true; }
            } else { this.error = 'Empty response from service.'; }
        } catch (e) {
            this.error = 'Error calling Apex: ' + (e.body?.message || e.message);
            console.error('LWC Apex call error:', JSON.stringify(e));
        } finally { this.isLoading = false; }
    }
    
    stripHtml(html) {
        if (!html) return "";
        try {
            let doc = new DOMParser().parseFromString(html, 'text/html');
            return doc.body.textContent || "";
        } catch (e) { return html.replace(/<[^>]*>?/gm, ''); }
    }

    closeModal() { this.isModalOpen = false; this.summaryText = ''; }
}
            </code></pre>

            <h4>3. <code>knowledgeCompanion.js-meta.xml</code> (Version A)</h4>
            <pre><code class="language-xml">
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;LightningComponentBundle xmlns="http://soap.sforce.com/2006/04/metadata"&gt;
    &lt;apiVersion&gt;59.0&lt;/apiVersion&gt; 
    &lt;isExposed&gt;true&lt;/isExposed&gt;
    &lt;targets&gt;
        &lt;target&gt;lightning__RecordPage&lt;/target&gt;
    &lt;/targets&gt;
    &lt;targetConfigs&gt;
        &lt;targetConfig targets="lightning__RecordPage"&gt;
            &lt;objects&gt;
                &lt;object&gt;Knowledge__kav&lt;/object&gt;
            &lt;/objects&gt;
        &lt;/targetConfig&gt;
    &lt;/targetConfigs&gt;
&lt;/LightningComponentBundle&gt;
            </code></pre>

            <hr style="margin: 2em 0;">
            <h3>Version B: Summarizing Full Page Text (`document.documentElement.outerText`)</h3>
            <p>This is the approach from the LWC code you provided earlier. It's suitable if the LWC is placed on a general page (like an Experience Cloud page) and you want to summarize its entire visible textual content.</p>
             <h4>1. <code>knowledgeCompanion.html</code> (for Version B)</h4>
            <pre><code class="language-html">
&lt;!-- File: knowledgeCompanion.html (for Version B - full page text) --&gt;
&lt;template&gt;
    &lt;div class="slds-p-around_medium"&gt;
        &lt;lightning-button
            label="AI Summarise This Page"
            onclick={handleSummarizeCurrentPageText}
            class="slds-m-bottom_medium"
            variant="brand"
            disabled={isLoading}&gt;
        &lt;/lightning-button&gt;
    &lt;/div&gt;
    &lt;template if:true={isLoading}&gt;
        &lt;div class="slds-m-around_medium"&gt;
            &lt;lightning-spinner alternative-text="Summarising page..." size="medium"&gt;&lt;/lightning-spinner&gt;
        &lt;/div&gt;
    &lt;/template&gt;
    &lt;template if:true={error}&gt;
         &lt;div class="slds-m-around_medium slds-text-color_error"&gt;
            &lt;p&gt;&lt;strong&gt;Error:&lt;/strong&gt; {error}&lt;/p&gt;
        &lt;/div&gt;
    &lt;/template&gt;
    &lt;template if:true={isModalOpen}&gt;
        &lt;section role="dialog" tabindex="-1" aria-modal="true" class="slds-modal slds-fade-in-open"&gt;
            &lt;div class="slds-modal__container"&gt;
                &lt;header class="slds-modal__header"&gt;
                    &lt;button class="slds-button slds-button_icon slds-modal__close slds-button_icon-inverse" title="Close" onclick={closeModal}&gt;
                        &lt;lightning-icon icon-name="utility:close" alternative-text="Close" variant="inverse" size="small"&gt;&lt;/lightning-icon&gt;
                    &lt;/button&gt;
                    &lt;h2 class="slds-modal__title slds-hyphenate"&gt;Page Summary&lt;/h2&gt;
                &lt;/header&gt;
                &lt;div class="slds-modal__content slds-p-around_medium"&gt;
                    &lt;lightning-formatted-rich-text value={summaryText}&gt;&lt;/lightning-formatted-rich-text&gt;
                &lt;/div&gt;
                &lt;footer class="slds-modal__footer"&gt;
                    &lt;lightning-button label="Close" onclick={closeModal}&gt;&lt;/lightning-button&gt;
                &lt;/footer&gt;
            &lt;/div&gt;
        &lt;/section&gt;
        &lt;div class="slds-backdrop slds-backdrop_open"&gt;&lt;/div&gt;
    &lt;/template&gt;
&lt;/template&gt;
            </code></pre>
            <h4>2. <code>knowledgeCompanion.js</code> (for Version B)</h4>
            <pre><code class="language-javascript">
// File: knowledgeCompanion.js (Version B: Summarizing document.documentElement.outerText)
import { LightningElement, track } from 'lwc';
import getPageSummaryFromGemini from '@salesforce/apex/GeminiAPIService.getPageSummaryFromGemini';

export default class KnowledgeCompanionPageSummarizer extends LightningElement {
    @track summaryText = '';
    @track isLoading = false;
    @track error;
    @track isModalOpen = false;
    // Using the label directly in HTML for simplicity, or you can use a getter:
    // get AISUMMARIZEBUTTON() { return 'AI Summarise This Page'; }


    async handleSummarizeCurrentPageText() {
        this.isLoading = true;
        this.error = undefined;
        this.summaryText = '';
        console.log('Attempting to summarize current page text using document.documentElement.outerText...');

        const mainContent = document.documentElement.outerText || '';

        if (!mainContent || mainContent.trim().length < 100) { 
            this.error = 'Page content is too short or could not be extracted for summarization.';
            this.isLoading = false;
            // alert(this.error); // Consider if alert is best UX
            return;
        }

        try {
            const result = await getPageSummaryFromGemini({ htmlText: mainContent });
            
            if (result) {
                if (result.toLowerCase().startsWith('error:')) {
                    this.error = result;
                } else {
                    const cleanedResult = result.replace(/```html/gi, '').replace(/```/g, '').trim();
                    this.summaryText = cleanedResult;
                    this.isModalOpen = true;
                }
            } else {
                this.error = 'Empty response from page summarization service.';
            }
        } catch (e) {
            this.error = 'Error during page summarization: ' + (e.body?.message || e.message);
            console.error('LWC Apex call error (page summarization):', JSON.stringify(e));
        } finally {
            this.isLoading = false;
        }
    }

    closeModal() {
        this.isModalOpen = false;
        this.summaryText = '';
    }
}
            </code></pre>
             <h4>3. <code>knowledgeCompanion.js-meta.xml</code> (Version B - Example Targets)</h4>
            <pre><code class="language-xml">
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;LightningComponentBundle xmlns="http://soap.sforce.com/2006/04/metadata"&gt;
    &lt;apiVersion&gt;59.0&lt;/apiVersion&gt; 
    &lt;isExposed&gt;true&lt;/isExposed&gt;
    &lt;targets&gt;
        &lt;!-- Add targets appropriate for where you want to use this full-page summarizer --&gt;
        &lt;target&gt;lightningCommunity__Page&lt;/target&gt;
        &lt;target&gt;lightningCommunity__Default&lt;/target&gt;
        &lt;!-- &lt;target&gt;lightning__AppPage&lt;/target&gt; --&gt;
        &lt;!-- &lt;target&gt;lightning__HomePage&lt;/target&gt; --&gt;
    &lt;/targets&gt;
&lt;/LightningComponentBundle&gt;
            </code></pre>
        </div>

        <div class="slide" id="slide7">
            <h2>Lab Step 4: Simulation & Visuals üìä</h2>
            <h3>Workflow Animation</h3>
            <p>This D3.js animation visualizes the data flow. Click "Replay Animation" to restart it.</p>
            <div id="workflowAnimation"></div>
            <button onclick="startWorkflowAnimation()" class="slds-button slds-button_neutral slds-m-top_small">Replay Animation</button>

            <h3 class="slds-m-top_large">Before/After Summary View (Toggle Example)</h3>
            <div class="summary-toggle-container">
                <p>This is a static example to simulate how long text can be condensed. Click the button to toggle.</p>
                <button id="toggleSummaryBtn" onclick="toggleSummaryView()" class="slds-button slds-button_brand">Show AI Summary Example</button>
                <div id="originalTextView" class="summary-text-area">
                    <h4>Original Document Text (Example)</h4>
                    <p>The Q4 Global Sales Initiative, codenamed "Project Everest," aims to expand market penetration in emerging APAC regions by 15% and increase overall recurring revenue by 10% through strategic partnerships and a revamped digital marketing strategy. Key performance indicators (KPIs) will include new customer acquisition rates, average deal size, and customer lifetime value. The initiative will involve cross-functional teams from Sales, Marketing, and Product Development, with a projected timeline of six months, starting January 1st. Bi-weekly progress reports will be submitted to the executive leadership team, outlining achievements, challenges, and mitigation strategies. A dedicated budget of $2.5 million has been allocated for this initiative, covering marketing campaigns, sales incentives, and technology upgrades. Training sessions for the sales team on new product features and market positioning are scheduled for mid-December. The success of Project Everest is critical for achieving the company's annual growth targets and strengthening its competitive position in the global market. All team members are expected to fully commit to their roles and responsibilities to ensure the project's objectives are met within the stipulated timeframe and budget.</p>
                </div>
                <div id="summaryAfterView" class="summary-text-area">
                    <h4>AI Generated Summary (Example)</h4>
                    <p>"Project Everest," a 6-month, $2.5M Q4 initiative, targets a 15% APAC market expansion and 10% recurring revenue growth via partnerships and digital marketing. KPIs include customer acquisition, deal size, and lifetime value. Cross-functional teams will report bi-weekly to executives. Success is vital for annual growth and market position.</p>
                </div>
            </div>
        </div>

        <div class="slide" id="slide8">
            <h2>Congratulations & Next Steps üéâ</h2>
            <h3>What You've Accomplished in this Lab üèÜ</h3>
            <ul>
                <li>Set up pre-requisites including Salesforce org configuration and understanding API key usage.</li>
                <li>Configured the lab environment to use a provided Gemini API Key.</li>
                <li>Developed an Apex class to make callouts to the Gemini API for text summarization.</li>
                <li>Built a Lightning Web Component (LWC) to provide a user interface.</li>
                <li>Implemented LWC-to-Apex communication to trigger the AI summarization.</li>
                <li>Explored how prompts can be crafted to guide the AI's output.</li>
            </ul>
            <h3>Potential Project Implementations & Enhancements üöÄ</h3>
            <ul>
                <li>Adapt to summarize Case descriptions, EmailMessage bodies, Account notes, or Chatter posts.</li>
                <li>Implement batch Apex to summarize multiple records.</li>
                <li>Experiment with different prompts for various summary styles or information extraction.</li>
                <li>Integrate with Salesforce Flow or Process Builder.</li>
                <li>Explore secure API key storage (Named Credentials, Protected Custom Settings) for your own projects.</li>
            </ul>
            <h3>Further Reading & Resources üìö</h3>
            <ul>
                <li><a href="https://ai.google.dev/docs/gemini_api_overview" target="_blank">Google Gemini API Documentation</a></li>
                <li><a href="https://developer.salesforce.com/docs/" target="_blank">Salesforce Developer Guide</a></li>
                <li><a href="https://developer.salesforce.com/docs/component-library/documentation/en/lwc" target="_blank">Lightning Web Components Dev Guide</a></li>
                <li>Trailhead: Search for "Apex Integration Services", "Lightning Web Components Basics".</li>
            </ul>
            <p>Keep exploring, keep building, and happy coding!</p>
        </div>

        <div class="slide" id="slide9">
            <h2>Appendix: For Your Reference ‚ÑπÔ∏è</h2>
            <p>This section provides information for your future projects beyond this lab.</p>
            <h3>A. How to Obtain Your Own Google Gemini API Key</h3>
            <ol>
                <li>Go to <a href="https://makersuite.google.com/app/apikey" target="_blank">Google AI Studio</a>.</li>
                <li>Sign in with your Google account. If you don't have one, you'll need to create it.</li>
                <li>You might need to enable the "Generative Language API" in a Google Cloud Project associated with your account. Google AI Studio often guides you through this.
                    <ul>
                        <li>If creating a new project, ensure billing is enabled for that project if required by Google Cloud for API usage beyond free tiers.</li>
                    </ul>
                </li>
                <li>In Google AI Studio, click on "Get API key".</li>
                <li>Select or create a project, then click "Create API key".</li>
                <li>Copy the generated API key and store it securely (e.g., in a password manager). <strong>Treat this key like a password.</strong></li>
            </ol>

            <h3>B. Using Named Credentials in Salesforce (Best Practice for API Integration)</h3>
            <p>Named Credentials provide a secure way to manage authentication and endpoint details for callouts, keeping sensitive information out of your code.</p>
            <ol>
                <li><strong>Store API Key Securely:</strong>
                    <ul>
                        <li>Use a **Protected Custom Setting** or **Protected Custom Metadata Type** to store your Gemini API Key. This prevents it from being visible in code or easily deployable in clear text.</li>
                    </ul>
                </li>
                <li><strong>Create the Named Credential:</strong>
                    <ul>
                        <li>In Salesforce Setup, search for "Named Credentials".</li>
                        <li>Click **New Named Credential**.</li>
                        <li>**Label:** e.g., `My_Gemini_API`</li>
                        <li>**Name:** (Auto-filled, e.g., `My_Gemini_API`)</li>
                        <li>**URL:** `https://generativelanguage.googleapis.com`</li>
                        <li>**Identity Type:** `Named Principal` (common choice) or `Per User`.</li>
                        <li>**Authentication Protocol:** `Password Authentication` (if you plan to use the password field for something related to auth, though for API keys in headers, this isn't directly used) OR `No Authentication` if you handle all auth via headers from Apex. For API keys, often you just need to add it as a custom header.</li>
                        <li>**Generate Authorization Header:** Typically Unchecked if you are manually adding an `x-goog-api-key` header.</li>
                        <li>(Optional) **Custom Headers:** You can define custom headers directly in the Named Credential.
                            <ul>
                                <li>Header Name: `x-goog-api-key`</li>
                                <li>Header Value: Your Gemini API Key (or `{!'formula_to_your_custom_setting_key'}` if using a formula to reference it from a custom setting). This is a very secure way.</li>
                            </ul>
                        </li>
                        <li>Save.</li>
                    </ul>
                </li>
                <li><strong>Update Apex Code to Use Named Credential:</strong>
                    <pre><code class="language-apex">
// Example Apex using Named Credential
HttpRequest req = new HttpRequest();
// The endpoint uses 'callout:' followed by the Named Credential Name
req.setEndpoint('callout:My_Gemini_API/v1beta/models/gemini-1.5-flash:generateContent');
req.setMethod('POST');
req.setHeader('Content-Type', 'application/json; charset=utf-8');
// If x-goog-api-key is NOT set as a Custom Header in Named Credential:
// String apiKey = getApiKeyFromSecureStorage(); // Your method to get key
// req.setHeader('x-goog-api-key', apiKey); 
// ... rest of your request setup and callout ...
                    </code></pre>
                </li>
            </ol>
            <p>Using Named Credentials with Custom Headers (or retrieving keys from Protected Custom Settings/Metadata within Apex) is highly recommended for better security and maintainability in your Salesforce projects.</p>
        </div>

    </div> <div class="navigation-buttons">
        <button id="prevBtn" onclick="changeSlide(-1)">‚ùÆ Previous</button>
        <button id="nextBtn" onclick="changeSlide(1)">Next ‚ùØ</button>
    </div>

    <script>
        // --- Slide Navigation Logic ---
        let currentSlide = 0;
        const slides = document.querySelectorAll('.slide');
        const totalSlides = slides.length;
        const prevButton = document.getElementById('prevBtn');
        const nextButton = document.getElementById('nextBtn');

        function showSlide(index) {
            if (!slides || slides.length === 0) {
                console.error("Slides not found. Navigation cannot work.");
                return;
            }
            if (index < 0 || index >= totalSlides) {
                console.error("Invalid slide index:", index);
                return;
            }
            slides.forEach((slideEl, i) => {
                slideEl.classList.remove('active');
                if (i === index) {
                    slideEl.classList.add('active');
                }
            });
            currentSlide = index;
            updateNavButtons();

            // Slide 7 is at index 6 (0-indexed) for workflow animation
            // Slide 8 is wrap-up at index 7
            // Slide 9 is appendix at index 8
            if (index === 6) { 
                startWorkflowAnimation();
            }
        }

        function changeSlide(step) {
            let newSlideIndex = currentSlide + step;
            if (newSlideIndex >= 0 && newSlideIndex < totalSlides) {
                showSlide(newSlideIndex);
            }
        }
        
        function updateNavButtons() {
            if (prevButton) {
                prevButton.disabled = (currentSlide === 0);
            }
            if (nextButton) {
                nextButton.disabled = (currentSlide === totalSlides - 1);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            if (slides.length > 0) {
                if (prevButton && nextButton) {
                    showSlide(0);
                } else {
                    console.error("Navigation buttons not found. Navigation will be disabled.");
                }
            } else {
                console.error("No slides with class '.slide' found. Navigation will not work.");
                if(prevButton) prevButton.disabled = true;
                if(nextButton) nextButton.disabled = true;
            }
            
            const toggleBtn = document.getElementById('toggleSummaryBtn');
            const summaryView = document.getElementById('summaryAfterView');
            if (toggleBtn && summaryView) {
                 if (summaryView.style.display === 'none' || summaryView.style.display === '') {
                    toggleBtn.textContent = 'Show AI Summary Example';
                } else {
                    toggleBtn.textContent = 'Show Original Text';
                }
            }
            // Syntax highlighting function removed for plain code display
        });

        function startWorkflowAnimation() {
            const svgContainer = d3.select("#workflowAnimation");
            svgContainer.selectAll("*").remove(); 
            const bounds = svgContainer.node()?.getBoundingClientRect();
            if (!bounds || bounds.width <= 0 || bounds.height <= 0) {
                console.warn("D3 container has no valid dimensions. Skipping animation.");
                return;
            }
            const width = bounds.width; const height = bounds.height;
            const svg = svgContainer.append("svg").attr("width", width).attr("height", height).attr("viewBox", `0 0 ${width} ${height}`).style("overflow", "visible");
            const nodeRadius = Math.min(width, height) * 0.05; const fontSize = Math.min(width, height) * 0.025;
            const nodesData = [
                { id: 1, name: "User Clicks Summarise", x: width * 0.2, y: height * 0.3 }, { id: 2, name: "Apex Callout", x: width * 0.4, y: height * 0.3 },
                { id: 3, name: "SF Sends Request", x: width * 0.5, y: height * 0.15 }, { id: 4, name: "Gemini API Processes", x: width * 0.7, y: height * 0.15 },
                { id: 5, name: "Gemini Responds", x: width * 0.5, y: height * 0.85 }, { id: 6, name: "Apex Receives", x: width * 0.4, y: height * 0.7 },
                { id: 7, name: "Summary Displayed", x: width * 0.2, y: height * 0.7 }
            ];
            const linksData = [
                { source: nodesData[0], target: nodesData[1], label: "1. UI Event" }, { source: nodesData[1], target: nodesData[2], label: "2. To SF Server" },
                { source: nodesData[2], target: nodesData[3], label: "3. To Gemini" }, { source: nodesData[3], target: nodesData[4], label: "4. AI Response" },
                { source: nodesData[4], target: nodesData[5], label: "5. Back to SF" }, { source: nodesData[5], target: nodesData[6], label: "6. Update UI" }
            ];
            svg.append("defs").append("marker").attr("id", "arrow").attr("viewBox", "0 -5 10 10").attr("refX", nodeRadius * 0.7 + 5).attr("refY", 0).attr("markerWidth", 6).attr("markerHeight", 6).attr("orient", "auto-start-reverse").append("path").attr("d", "M0,-5L10,0L0,5").style("fill", "#555");
            const nodeElements = svg.selectAll("g.node").data(nodesData).enter().append("g").attr("class", "node").attr("transform", d => `translate(${d.x},${d.y})`);
            nodeElements.append("circle").attr("r", nodeRadius).style("fill", "#00A1E0").style("stroke", "#0070D2").style("stroke-width", 2);
            nodeElements.append("text").text(d => d.name).attr("x", 0).attr("y", nodeRadius + fontSize * 1.2).style("font-size", `${fontSize}px`).style("fill", "#333").style("text-anchor", "middle");
            let animationDelay = 0; const stepDuration = 1000; const highlightDuration = 500;
            linksData.forEach((link, i) => {
                const path = svg.append("line").attr("x1", link.source.x).attr("y1", link.source.y).attr("x2", link.source.x).attr("y2", link.source.y).attr("stroke", "#aaa").attr("stroke-width", 2).attr("marker-end", "url(#arrow)");
                const label = svg.append("text").text(link.label).attr("x", (link.source.x + link.target.x) / 2).attr("y", (link.source.y + link.target.y) / 2 - 5).style("font-size", `${fontSize*0.8}px`).style("fill", "#555").style("text-anchor", "middle").style("opacity",0);
                d3.select(nodeElements.nodes()[i]).select("circle").transition().delay(animationDelay).duration(highlightDuration).style("fill","orange"); animationDelay += highlightDuration;
                path.transition().delay(animationDelay).duration(stepDuration).attr("x2",link.target.x).attr("y2",link.target.y);
                label.transition().delay(animationDelay + stepDuration/2).duration(highlightDuration).style("opacity",1); animationDelay += stepDuration;
                d3.select(nodeElements.nodes()[i]).select("circle").transition().delay(animationDelay).duration(highlightDuration).style("fill","#5cb85c");
            });
            if(nodesData.length > 0 && nodeElements.nodes()[nodesData.length-1]){d3.select(nodeElements.nodes()[nodesData.length-1]).select("circle").transition().delay(animationDelay).duration(highlightDuration).style("fill","#5cb85c");}
        }
        
        function toggleSummaryView() {
            const originalView = document.getElementById('originalTextView');
            const summaryView = document.getElementById('summaryAfterView');
            const button = document.getElementById('toggleSummaryBtn');
            if (summaryView && originalView && button) {
                if (summaryView.style.display === 'none' || summaryView.style.display === '') {
                    originalView.style.display = 'none'; summaryView.style.display = 'block'; button.textContent = 'Show Original Text';
                } else {
                    originalView.style.display = 'block'; summaryView.style.display = 'none'; button.textContent = 'Show AI Summary Example';
                }
            }
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Salesforce Developer Lab Hackathon: Knowledge Companion</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            line-height: 1.7; /* Increased for readability */
            margin: 0;
            padding: 0;
            background-color: #f4f7f9;
            color: #333;
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 17px; /* Slightly larger base font */
        }

        .progress-bar-container {
            width: 100%;
            height: 8px;
            background-color: #e0e0e0;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1001; /* Above modal backdrop */
        }

        .progress-bar {
            height: 100%;
            width: 0%; /* Initial width */
            background-color: #0070d2; /* Salesforce blue */
            transition: width 0.3s ease-out;
        }

        .slide-container {
            width: 90%;
            max-width: 1000px;
            margin: 40px auto 20px auto; /* Increased top margin for progress bar */
            background-color: #fff;
            border: 1px solid #ddd;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); /* Slightly enhanced shadow */
            border-radius: 8px; /* Added border-radius */
            overflow: hidden;
        }

        .slide {
            display: none;
            padding: 30px 40px;
            min-height: 400px;
            animation: fadeIn 0.5s ease-in-out;
        }

        .slide.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        h1, h2, h3, h4 {
            color: #003972; 
            margin-bottom: 0.75em;
        }
        h1 { font-size: 2.2em; text-align: center; margin-bottom: 1em; color: #001B35; }
        h2 { font-size: 1.8em; border-bottom: 2px solid #00A1E0; padding-bottom: 0.3em; margin-top: 1.5em;}
        h3 { font-size: 1.4em; margin-top: 1.2em; }
        h4 { font-size: 1.1em; font-style: italic; color: #555;}

        p, ul, ol {
            margin-bottom: 1em;
        }

        ul, ol {
            padding-left: 25px; /* Slightly more padding for lists */
        }
        li { margin-bottom: 0.6em; } /* Slightly more spacing for list items */

        a {
            color: #0070d2;
            text-decoration: none;
            transition: color 0.2s ease-in-out, text-decoration 0.2s ease-in-out;
        }
        a:hover {
            color: #005fb2;
            text-decoration: underline;
        }

        code { 
            font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, Courier, monospace;
            background-color: #eef1f3;
            padding: 0.2em 0.4em;
            border-radius: 4px; /* Consistent border-radius */
            font-size: 0.88em; /* Adjusted relative to new body font */
        }

        .code-block-wrapper {
            position: relative;
            margin-bottom: 1em;
        }

        pre { 
            background-color: #2d2d2d; 
            color: #f0f0f0; /* Brighter white for better contrast on dark */
            padding: 20px; /* Increased padding */
            padding-top: 45px; 
            border-radius: 6px; /* Consistent border-radius */
            overflow-x: auto; 
            font-size: 0.88em; 
            line-height: 1.6; /* Increased line-height for code */
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            white-space: pre; 
        }
        pre code { 
            background-color: transparent;
            padding: 0;
            font-size: 1em; 
            color: inherit; 
            white-space: inherit; 
        }
        
        .copy-code-button {
            position: absolute;
            top: 8px; /* Adjusted position */
            right: 8px;
            background-color: #0070d2;
            color: white;
            border: 1px solid #005fb2; /* Added subtle border */
            padding: 6px 12px; /* Adjusted padding */
            font-size: 0.8em;
            font-weight: bold;
            border-radius: 4px;
            cursor: pointer;
            opacity: 0.8;
            transition: opacity 0.2s ease-in-out, background-color 0.2s ease-in-out;
        }
        .copy-code-button:hover {
            opacity: 1;
            background-color: #005fb2;
        }
        .copy-code-button.copied {
            background-color: #28a745; 
            border-color: #1e7e34;
            opacity: 1;
        }

        .navigation-buttons {
            display: flex;
            justify-content: space-between;
            padding: 20px 40px;
            background-color: #f0f0f0;
            border-top: 1px solid #ccc;
            width: 90%;
            max-width: 1000px;
            box-sizing: border-box;
            margin: 0 auto 20px auto; 
            border-bottom-left-radius: 8px; /* Match slide container */
            border-bottom-right-radius: 8px;
        }

        .navigation-buttons button { 
            background-color: #0070d2;
            color: white;
            border: none;
            padding: 10px 20px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 1em; /* Relative to body font */
            font-weight: 500;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .navigation-buttons button:hover:not(:disabled) {
            background-color: #005fb2;
        }
        .navigation-buttons button:disabled {
            background-color: #c0c0c0;
            cursor: not-allowed;
        }
        
        .replay-button { 
            background-color: #5cb85c; 
            color: white;
            border: none;
            padding: 10px 18px; /* Harmonized padding */
            font-size: 0.95em; /* Harmonized size */
            font-weight: bold;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.1s ease;
            margin-top: 15px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .replay-button:hover {
            background-color: #4cae4c; 
            transform: translateY(-1px);
        }
        .replay-button:active {
            transform: translateY(0px);
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .summary-toggle-button { 
            background-color: #ff7f50; 
            color: white;
            border: none;
            padding: 10px 18px;
            font-size: 0.95em;
            font-weight: bold;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.1s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .summary-toggle-button:hover {
            background-color: #ff6347; 
            transform: translateY(-1px); 
        }
        .summary-toggle-button:active {
            transform: translateY(0px);
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .note {
            padding: 12px 18px; /* Increased padding */
            margin: 20px 0; /* Increased margin */
            border-radius: 6px; /* Consistent border-radius */
            border-left-width: 6px; /* Thicker border */
            box-shadow: 0 1px 3px rgba(0,0,0,0.05); /* Subtle shadow */
        }
        .note strong { font-weight: 600; } /* Slightly bolder */
        .note::before {
            font-weight: bold;
            margin-right: 8px;
        }

        /* Specific note types */
        .note-general { background-color: #eef1f3; border-left-color: #0070d2; color: #003972; }
        .note-general::before { content: "‚ÑπÔ∏è"; }
        .note-important { background-color: #fff3cd; border-left-color: #ffeeba; color: #856404;}
        .note-important::before { content: "‚ö†Ô∏è"; }
        .note-action { background-color: #d4edda; border-left-color: #c3e6cb; color: #155724;}
        .note-action::before { content: "‚û°Ô∏è"; }
        .note-tip { background-color: #d1ecf1; border-left-color: #bee5eb; color: #0c5460;}
        .note-tip::before { content: "üí°"; }


        .modal { 
            display: none; position: fixed; z-index: 1000;
            left: 0; top: 0; width: 100%; height: 100%;
            overflow: auto; background-color: rgba(0,0,0,0.5); /* Darker backdrop */
        }
        .modal-content {
            background-color: #fefefe; margin: 10% auto; /* Adjusted margin */ padding: 25px; /* Increased padding */
            border: 1px solid #ccc; width: 65%; max-width: 700px; /* Max width */ border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .modal-content h3 { margin-top: 0;}

        #workflowAnimation {
            width: 100%; height: 400px; border: 1px solid #e0e0e0; /* Softer border */
            margin-top: 20px; background-color: #f9f9f9; border-radius: 6px; /* Added radius */
        }
        #workflowAnimation svg { display: block; width: 100%; height: 100%;}

        .summary-toggle-container {
            margin-top: 20px; padding: 20px; background-color: #e9ecef; border-radius: 6px;
        }
        .summary-text-area {
            border: 1px dashed #ced4da; padding: 15px; min-height: 100px; background-color: #fff;
            margin-top: 15px; border-radius: 4px;
        }
        #summaryAfterView { display: none; }
    </style>
</head>
<body>
    <div class="progress-bar-container">
        <div class="progress-bar" id="progressBar"></div>
    </div>

    <h1>üöÄ Salesforce Developer Lab: Knowledge Companion - Document Summariser üìÑ</h1>

    <div class="slide-container">
        <div class="slide active" id="slide1">
            <h2>Lab Overview & Business Impact</h2>
            <h3>The Challenge: Information Overload üò©</h3>
            <p>In today's fast-paced environment, users are often confronted with vast amounts of text. Quickly understanding the essence of long documents like Salesforce <strong>Knowledge Articles</strong>, detailed <strong>Case Descriptions</strong>, or comprehensive <strong>Product Manuals</strong> is crucial but time-consuming.</p>
            <h3>The Solution: Knowledge Companion ‚ú®</h3>
            <p>This lab guides you in building a "Knowledge Companion" tool. Powered by the <strong>Gemini API</strong> (e.g., Gemini Flash 1.5 or newer compatible Flash models), this tool integrates directly into Salesforce to provide instant summaries of lengthy text content. This significantly enhances productivity by allowing users to grasp key information at a glance.</p>
            <h3>Real-Life Use Cases üí°</h3>
            <ul>
                <li><strong>Support Agents:</strong> Quickly summarize complex case histories or long knowledge articles.</li>
                <li><strong>Sales Teams:</strong> Get rapid summaries of account details, past communications, or opportunity notes.</li>
                <li><strong>Product Managers:</strong> Condense user feedback or technical documentation.</li>
            </ul>
        </div>

        <div class="slide" id="slide2">
            <h2>Lab Goal üéØ</h2>
            <p>By the end of this lab, you will have built a solution that can:</p>
            <ul>
                <li>Summarize content from a rich text area field on a Salesforce Knowledge Article using the Gemini API.</li>
                <li>Trigger this summarization process via a custom Lightning Web Component (LWC) button.</li>
                <li>Display the AI-generated summary clearly within a modal dialog on the screen.</li>
                <li><strong>Explore your creativity</strong> in crafting effective prompts to the Gemini API to summarize different types of content from a Knowledge Article field in innovative ways.</li>
            </ul>
            <p>This hands-on experience will cover Salesforce configuration, Apex development, and LWC creation.</p>
        </div>

        <div class="slide" id="slide3">
            <h2>Pre-requisites üõ†Ô∏è</h2>
            <p>Before we begin building, please ensure you have the following:</p>
            <h3>1. Salesforce Developer Org</h3>
            <ul>
                <li>A Salesforce Developer Edition org with admin privileges.</li>
                <li>Salesforce Knowledge enabled: (Setup &gt; Knowledge &gt; Knowledge Settings).</li>
                <li>A custom field (e.g., Text Area (Rich) like <code>Content_for_Summarization__c</code>) on the Knowledge Article object (<code>Knowledge__kav</code>) for the text to be summarized. Note its API name.</li>
                <li>Your user profile needs "API Enabled" system permission and CRUD permissions for Knowledge articles and your chosen field.</li>
            </ul>
            <h3>2. Google Gemini API Key (Provided for this Lab)</h3>
            <ul>
                <li>A **common Google Gemini API Key will be provided by the instructors.**</li>
                <li>You will use this key directly in the Apex code as instructed.</li>
            </ul>
            <h3>3. Basic Familiarity (Helpful)</h3>
            <ul>
                <li>Basic understanding of Salesforce Apex and Lightning Web Components.</li>
            </ul>
            <div class="note note-tip">
                <strong>Tip:</strong> Ensure your browser pop-up blocker is not interfering with any Salesforce or Google AI Studio authentication steps if you explore creating your own key later (see Appendix).
            </div>
        </div>

        <div class="slide" id="slide4">
            <h2>Lab Step 1: Gemini API Configuration (Using Provided Key) üîë</h2>
            <p>For this lab, we'll use the common API key provided by your instructors directly in the Apex code for simplicity.</p>
            <h3>1. Using the Provided API Key</h3>
            <ul>
                <li>You will receive a Gemini API Key from the lab instructors.</li>
                <li>In the Apex class (in a later step), you will insert this key into a specific placeholder variable.</li>
                <li>The Apex code will then construct the API endpoint URL and include this key for authentication.</li>
            </ul>
            <h3>2. Important Note: API Key in Endpoint vs. Named Credentials</h3>
            <div class="note note-important">
                <p><strong>For Lab Simplicity:</strong> We are putting the API key directly into the Apex code and constructing the endpoint URL with it.</p>
                <p><strong>Security Best Practice (for real projects): DO NOT hardcode API keys or include them directly in endpoint URLs in your code.</strong> Use Named Credentials or retrieve keys from Protected Custom Settings/Metadata.</p>
                <p>An appendix slide provides details on obtaining your own key and setting up Named Credentials for future reference.</p>
            </div>
        </div>

        <div class="slide" id="slide5">
            <h2>Lab Step 2: Simulation & Visuals üìä</h2>
            <p>Before diving into code, let's visualize the data flow and an example of the summarization we aim to achieve.</p>
            <h3>Workflow Animation</h3>
            <p>This D3.js animation visualizes the data flow when you click "AI Summarise". Click "Replay Animation" to restart it.</p>
            <div id="workflowAnimation"></div>
            <button onclick="startWorkflowAnimation()" class="replay-button">üé® Replay Animation</button> 

            <h3 class="slds-m-top_large">Before/After Summary View (Summarise Example)</h3> 
            <div class="summary-toggle-container">
                <p>This is a static example to simulate how long text can be condensed. Click the button to toggle between the original content and its AI-generated summary.</p>
                <button id="toggleSummaryBtn" onclick="toggleSummaryView()" class="summary-toggle-button">‚ú® Show AI Summary Example</button> 
                <div id="originalTextView" class="summary-text-area">
                    <h4>Original Document Text (Example)</h4>
                    <p>The Q4 Global Sales Initiative, codenamed "Project Everest," aims to expand market penetration in emerging APAC regions by 15% and increase overall recurring revenue by 10% through strategic partnerships and a revamped digital marketing strategy. Key performance indicators (KPIs) will include new customer acquisition rates, average deal size, and customer lifetime value. The initiative will involve cross-functional teams from Sales, Marketing, and Product Development, with a projected timeline of six months, starting January 1st. Bi-weekly progress reports will be submitted to the executive leadership team, outlining achievements, challenges, and mitigation strategies. A dedicated budget of $2.5 million has been allocated for this initiative, covering marketing campaigns, sales incentives, and technology upgrades. Training sessions for the sales team on new product features and market positioning are scheduled for mid-December. The success of Project Everest is critical for achieving the company's annual growth targets and strengthening its competitive position in the global market. All team members are expected to fully commit to their roles and responsibilities to ensure the project's objectives are met within the stipulated timeframe and budget.</p>
                </div>
                <div id="summaryAfterView" class="summary-text-area">
                    <h4>AI Generated Summary (Example)</h4>
                    <p>"Project Everest," a 6-month, $2.5M Q4 initiative, targets a 15% APAC market expansion and 10% recurring revenue growth via partnerships and digital marketing. KPIs include customer acquisition, deal size, and lifetime value. Cross-functional teams will report bi-weekly to executives. Success is vital for annual growth and market position.</p>
                </div>
            </div>
        </div>

        <div class="slide" id="slide6">
            <h2>Lab Step 3: Apex Code Walkthrough üë®‚Äçüíª</h2>
            <p>This Apex class (<code>GeminiAPIService.cls</code>) makes the callout to the Gemini API using the latest Flash model (e.g., Gemini Flash 1.5 or newer) and the provided API key.</p>
            <div class="note note-action">
                <strong>Action:</strong> Create this Apex class in your Salesforce org.
            </div>
            <div class="code-block-wrapper">
                <button class="copy-code-button" aria-label="Copy Apex Code">üìã Copy</button>
                <pre><code class="language-apex">
// File: GeminiAPIService.cls
public with sharing class GeminiAPIService {

    private static String getProvidedApiKey() {
        // TODO: LAB PARTICIPANT - REPLACE 'KEY_PROVIDED_BY_INSTRUCTOR' WITH THE ACTUAL API KEY.
        String apiKey = 'KEY_PROVIDED_BY_INSTRUCTOR'; 
        if (String.isBlank(apiKey) || apiKey == 'KEY_PROVIDED_BY_INSTRUCTOR') {
            System.debug(LoggingLevel.ERROR, 'GeminiAPIService: API Key is missing or placeholder.');
        }
        return apiKey;
    }

    @AuraEnabled(cacheable=false) 
    public static String getPageSummaryFromGemini(String articleFieldContent) {
        if (String.isBlank(articleFieldContent)) {
            return 'Error: Knowledge Article field content is blank.';
        }
        
        String GEMINI_API_KEY = getProvidedApiKey();
        if (String.isBlank(GEMINI_API_KEY) || GEMINI_API_KEY == 'KEY_PROVIDED_BY_INSTRUCTOR') {
            return 'Error: The provided Gemini API Key is not configured in Apex.';
        }

        String modelIdentifier = 'gemini-1.5-flash-latest'; 
        String endpoint = 'https://generativelanguage.googleapis.com/v1beta/models/' + modelIdentifier + ':generateContent?key=' + GEMINI_API_KEY;

        String prompt = 'You are an expert AI assistant. Your task is to summarize the content of a Salesforce Knowledge Article field. ' +
            'The content might be technical, procedural, or informational. ' +
            'Provide a concise, well-structured summary in HTML format. ' +
            'Use bullet points (&lt;ul&gt;&lt;li&gt;...&lt;/li&gt;&lt;/ul&gt;) for lists or key takeaways where appropriate. ' +
            'Focus on extracting the core information and main points from the provided text. ' +
            'The summary should be easily readable and directly usable by someone looking for the essence of the article content. ' +
            'Input text from Knowledge Article field:\n\n' + articleFieldContent;

        Map&lt;String, Object&gt; requestBody = new Map&lt;String, Object&gt;{
            'contents' => new List&lt;Object&gt;{
                new Map&lt;String, Object&gt;{
                    'parts' => new List&lt;Object&gt;{ new Map&lt;String, Object&gt;{ 'text' => prompt } }
                }
            }
        };

        HttpRequest req = new HttpRequest();
        req.setEndpoint(endpoint); 
        req.setMethod('POST');
        req.setHeader('Content-Type', 'application/json; charset=utf-8');
        req.setTimeout(60000); 
        req.setBody(JSON.serialize(requestBody));

        Http http = new Http();
        String summaryResult = '';

        try {
            HttpResponse res = http.send(req);
            if (res.getStatusCode() == 200) {
                Map&lt;String, Object&gt; jsonResponse = (Map&lt;String, Object&gt;) JSON.deserializeUntyped(res.getBody());
                List&lt;Object&gt; candidates = (List&lt;Object&gt;) jsonResponse.get('candidates');
                if (candidates != null && !candidates.isEmpty()) {
                    Map&lt;String, Object&gt; content = (Map&lt;String, Object&gt;) ((Map&lt;String, Object&gt;) candidates[0]).get('content');
                    if (content != null) {
                        List&lt;Object&gt; parts = (List&lt;Object&gt;) content.get('parts');
                        if (parts != null && !parts.isEmpty()) {
                            summaryResult = (String) ((Map&lt;String, Object&gt;) parts[0]).get('text');
                        } else { summaryResult = 'Error: No "parts" in response.'; }
                    } else { summaryResult = 'Error: No "content" in candidate.'; }
                } else { 
                    summaryResult = 'Error: No "candidates" in response.';
                    if (jsonResponse.containsKey('error')) {
                        summaryResult += ' API Error: ' + String.valueOf(((Map&lt;String, Object&gt;)jsonResponse.get('error')).get('message'));
                    }
                }
            } else { summaryResult = 'Error from API: ' + res.getStatusCode() + '. ' + res.getBody(); }
        } catch (Exception ex) {
            summaryResult = 'Error during callout: ' + ex.getMessage();
            System.debug(LoggingLevel.ERROR, 'GeminiAPIService Exception: ' + ex.getMessage() + '\\n' + ex.getStackTraceString());
        }
        return summaryResult;
    }
}
                </code></pre>
            </div>
            <div class="note note-important">
                <strong>Remember to replace <code>'KEY_PROVIDED_BY_INSTRUCTOR'</code> in the Apex code with your valid Gemini API Key.</strong>
            </div>
        </div>

        <div class="slide" id="slide7">
            <h2>Lab Step 4: Lightning Web Component (LWC) ‚ö°</h2>
            <p>Create an LWC named <code>knowledgeCompanion</code> for the Knowledge Article record page.</p>
            <div class="note note-action">
                <strong>Action:</strong> Create these three LWC files. **Remember to update the <code>KNOWLEDGE_CONTENT_FIELD</code> import in <code>knowledgeCompanion.js</code>**. Deploy and add to your Knowledge Article page.
            </div>

            <h3>1. <code>knowledgeCompanion.html</code></h3>
            <div class="code-block-wrapper">
                <button class="copy-code-button" aria-label="Copy LWC HTML">üìã Copy</button>
                <pre><code class="language-html">
&lt;!-- File: knowledgeCompanion.html --&gt;
&lt;template&gt;
    &lt;lightning-card title="Knowledge Article Summarizer" icon-name="utility:summarydetail"&gt;
        &lt;div class="slds-p-around_medium"&gt;
            &lt;lightning-button
                label="Summarise Article Content"
                variant="brand"
                onclick={handleSummarizeArticleField}
                disabled={isLoading}
                icon-name="utility:magicwand"&gt;
            &lt;/lightning-button&gt;
            &lt;template if:true={isLoading}&gt;
                &lt;div class="slds-m-top_medium slds-is-relative" style="height: 50px;"&gt;
                    &lt;lightning-spinner alternative-text="Loading summary..." size="medium"&gt;&lt;/lightning-spinner&gt;
                &lt;/div&gt;
            &lt;/template&gt;
            &lt;template if:true={error}&gt;
                &lt;div class="slds-m-top_medium slds-text-color_error"&gt;&lt;p&gt;&lt;strong&gt;Error:&lt;/strong&gt; {error}&lt;/p&gt;&lt;/div&gt;
            &lt;/template&gt;
        &lt;/div&gt;
    &lt;/lightning-card&gt;
    &lt;template if:true={isModalOpen}&gt;
        &lt;section role="dialog" tabindex="-1" aria-modal="true" class="slds-modal slds-fade-in-open"&gt;
            &lt;div class="slds-modal__container"&gt;
                &lt;header class="slds-modal__header"&gt;
                    &lt;button class="slds-button slds-button_icon slds-modal__close slds-button_icon-inverse" title="Close" onclick={closeModal}&gt;
                        &lt;lightning-icon icon-name="utility:close" alternative-text="Close" variant="inverse" size="small"&gt;&lt;/lightning-icon&gt;
                    &lt;/button&gt;
                    &lt;h2 class="slds-modal__title slds-hyphenate"&gt;Article Summary&lt;/h2&gt;
                &lt;/header&gt;
                &lt;div class="slds-modal__content slds-p-around_medium"&gt;
                    &lt;lightning-formatted-rich-text value={summaryText}&gt;&lt;/lightning-formatted-rich-text&gt;
                &lt;/div&gt;
                &lt;footer class="slds-modal__footer"&gt;&lt;lightning-button label="Close" title="Close" onclick={closeModal}&gt;&lt;/lightning-button&gt;&lt;/footer&gt;
            &lt;/div&gt;
        &lt;/section&gt;
        &lt;div class="slds-backdrop slds-backdrop_open" role="presentation"&gt;&lt;/div&gt;
    &lt;/template&gt;
&lt;/template&gt;
                </code></pre>
            </div>

            <h3 style="margin-top: 2em;">2. <code>knowledgeCompanion.js</code></h3>
            <div class="code-block-wrapper">
                <button class="copy-code-button" aria-label="Copy LWC JavaScript">üìã Copy</button>
                <pre><code class="language-javascript">
// File: knowledgeCompanion.js
import { LightningElement, api, wire, track } from 'lwc';
import { getRecord, getFieldValue } from 'lightning/uiRecordApi';
import getPageSummaryFromGemini from '@salesforce/apex/GeminiAPIService.getPageSummaryFromGemini';

// TODO: LAB PARTICIPANT - Update this import for YOUR Knowledge Article field.
// Example: import KNOWLEDGE_CONTENT_FIELD from '@salesforce/schema/Knowledge__kav.Your_Custom_Field_API_Name__c';
import KNOWLEDGE_CONTENT_FIELD from '@salesforce/schema/Knowledge__kav.Content_for_Summarization__c'; 

export default class KnowledgeCompanion extends LightningElement {
    @api recordId;
    @track summaryText = ''; @track isLoading = false; @track error; @track isModalOpen = false;
    _wiredArticleData;

    @wire(getRecord, { recordId: '$recordId', fields: [KNOWLEDGE_CONTENT_FIELD] })
    wiredArticle({ error, data }) {
        if (data) { this._wiredArticleData = data; this.error = undefined; }
        else if (error) { this.error = 'Failed to load article content. Check LWC field API name & permissions.'; console.error('LWC wire error:', JSON.stringify(error));}
    }

    get articleContent() {
        return this._wiredArticleData ? getFieldValue(this._wiredArticleData, KNOWLEDGE_CONTENT_FIELD) : undefined;
    }

    async handleSummarizeArticleField() {
        this.isLoading = true; this.error = undefined; this.summaryText = '';
        const contentValue = this.articleContent;

        if (!contentValue || String(contentValue).trim() === '') {
            this.error = \`Field '\${KNOWLEDGE_CONTENT_FIELD.fieldApiName}' is empty.\`;
            this.isLoading = false; return;
        }
        
        let plainTextContent = this.stripHtml(String(contentValue));
        if (!plainTextContent || plainTextContent.trim() === '') {
            this.error = 'Content empty after HTML stripping.'; this.isLoading = false; return;
        }

        try {
            const result = await getPageSummaryFromGemini({ articleFieldContent: plainTextContent }); // Match Apex param
            if (result) {
                if (result.toLowerCase().startsWith('error:')) { this.error = result; } 
                else { this.summaryText = result; this.isModalOpen = true; }
            } else { this.error = 'Empty response from service.'; }
        } catch (e) { this.error = 'Error calling Apex: ' + (e.body?.message || e.message); console.error('LWC Apex call error:', JSON.stringify(e));}
        finally { this.isLoading = false; }
    }
    
    stripHtml(html) {
        if (!html) return "";
        try { let doc = new DOMParser().parseFromString(html, 'text/html'); return doc.body.textContent || ""; }
        catch (e) { return html.replace(/<[^>]*>?/gm, ''); }
    }

    closeModal() { this.isModalOpen = false; this.summaryText = ''; }
}
                </code></pre>
            </div>

            <h3 style="margin-top: 2em;">3. <code>knowledgeCompanion.js-meta.xml</code></h3>
            <div class="code-block-wrapper">
                <button class="copy-code-button" aria-label="Copy LWC XML">üìã Copy</button>
                <pre><code class="language-xml">
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;LightningComponentBundle xmlns="http://soap.sforce.com/2006/04/metadata"&gt;
    &lt;apiVersion&gt;59.0&lt;/apiVersion&gt; 
    &lt;isExposed&gt;true&lt;/isExposed&gt;
    &lt;targets&gt;
        &lt;target&gt;lightning__RecordPage&lt;/target&gt;
    &lt;/targets&gt;
    &lt;targetConfigs&gt;
        &lt;targetConfig targets="lightning__RecordPage"&gt;
            &lt;objects&gt;
                &lt;object&gt;Knowledge__kav&lt;/object&gt;
            &lt;/objects&gt;
        &lt;/targetConfig&gt;
    &lt;/targetConfigs&gt;
&lt;/LightningComponentBundle&gt;
                </code></pre>
            </div>
        </div>
        
        <div class="slide" id="slide8">
            <h2>Alternative Approach: Salesforce Prompt Builder & Einstein ‚òÅÔ∏è</h2>
            <p>While this lab uses an external API, Salesforce offers powerful native Generative AI tools like **Prompt Builder** (part of the Einstein 1 Platform). This tool allows you to create, test, and manage AI prompts that leverage Large Language Models (LLMs) directly within Salesforce, often providing tighter data integration, better governance, and adherence to the Einstein Trust Layer.</p>
            
            <h3>Using Prompt Builder for Knowledge Article Summarization</h3>
            <p>Prompt Builder enables you to craft reusable and context-aware prompts for various tasks, including summarization of specific record fields from objects like Knowledge Articles.</p>

            <h4>Conceptual Steps with Prompt Builder:</h4>
            <ol>
                <li>
                    <strong>Access Prompt Builder:</strong> Navigate to "Prompt Builder" in Salesforce Setup.
                </li>
                <li>
                    <strong>Create a New Prompt Template:</strong>
                    <ul>
                        <li>Click "New Prompt Template". Choose a starting point, often a "Record Summary" type if available and suitable, or a more general "Template with Grounding" for flexibility.</li>
                        <li>Name it (e.g., `Knowledge_Article_Field_Summary_Template`).</li>
                        <li>Select the relevant SObject (e.g., `KnowledgeArticleVersion`).</li>
                    </ul>
                </li>
                <li>
                    <strong>Design the Prompt Text:</strong>
                    <ul>
                        <li>Write clear instructions for the LLM. This is where you define the desired output, tone, and format.</li>
                        <li>Use **merge fields** to dynamically insert content from your Knowledge Article record. For example, to include the content of a field with API name `Content_for_Summarization__c`, you'd use a merge field like `{!$Record.Content_for_Summarization__c}` (verify exact syntax in Prompt Builder).</li>
                        <li>Specify output requirements: "Summarize the following Knowledge Article content into 3-5 concise bullet points. The summary should be in HTML format, using `&lt;ul&gt;` and `&lt;li&gt;` tags. Focus on the primary purpose and key actionable information."</li>
                    </ul>
                </li>
                <li>
                    <strong>Grounding (Optional but Powerful):</strong>
                    <ul>
                        <li>Ground your prompt with relevant Salesforce data by referencing other fields from the Knowledge Article (e.g., `{!$Record.Title}`) or even fields from related records to give the LLM more context for a richer, more accurate summary.</li>
                    </ul>
                </li>
                <li>
                    <strong>Select an LLM & Test:</strong>
                    <ul>
                        <li>Choose from the Large Language Models made available by Salesforce through the Einstein 1 Platform.</li>
                        <li>Use the built-in testing interface. Provide a sample Knowledge Article record ID to see how the merge fields populate and how the LLM responds to your prompt. Iterate on your prompt text based on the results.</li>
                    </ul>
                </li>
                <li>
                    <strong>Save and Activate:</strong> Once you're satisfied with the prompt's performance, save and activate the template.
                </li>
                <li>
                    <strong>Integrate and Invoke:</strong>
                    <ul>
                        <li>**Flow:** Call the activated Prompt Template from a Salesforce Flow (e.g., a Screen Flow launched by a button on the Knowledge Article page). The Flow passes the record context (Record ID) to the prompt template and can then display the LLM's response.</li>
                        <li>**Apex:** Use Invocable Apex (`PromptTemplateService.execute` method) to execute the prompt template if you need more complex server-side logic or want to trigger it from other contexts.</li>
                        <li>**LWC:** A custom LWC can initiate the Flow or call the Apex method that invokes the prompt template.</li>
                    </ul>
                </li>
            </ol>
            <h4>Benefits of Using Prompt Builder:</h4>
            <ul>
                <li>**Declarative AI:** Build and manage sophisticated prompts with low-code tools.</li>
                <li>**Deep Salesforce Data Integration:** Seamlessly use merge fields and grounding with your CRM data.</li>
                <li>**Reusability & Governance:** Centrally manage, version, and control access to prompt templates.</li>
                <li>**Leverages Einstein Trust Layer:** Adheres to Salesforce's data security, privacy, and responsible AI principles.</li>
            </ul>
        </div>

        <div class="slide" id="slide9">
            <h2>Congratulations & Next Steps üéâ</h2>
            <h3>What You've Accomplished in this Lab üèÜ</h3>
            <ul>
                <li>Set up pre-requisites including Salesforce org configuration and using a provided API key.</li>
                <li>Developed an Apex class to make callouts to the Gemini API.</li>
                <li>Updated the Apex prompt for Knowledge Article summarization.</li>
                <li>Built an LWC to provide a UI on a Knowledge Article record page.</li>
                <li>Implemented LWC-to-Apex communication for AI summarization.</li>
                <li>Considered alternative native Salesforce AI approaches using Prompt Builder.</li>
            </ul>
            <h3>Potential Project Implementations & Enhancements üöÄ</h3>
            <ul>
                <li>Adapt to summarize other objects (Cases, Emails).</li>
                <li>Experiment with different prompts for various summary styles.</li>
                <li>Explore secure API key storage for your own projects (see Appendix).</li>
            </ul>
            <h3>Further Reading & Resources üìö</h3>
            <ul>
                <li><a href="https://ai.google.dev/docs/gemini_api_overview" target="_blank">Google Gemini API Documentation</a></li>
                <li><a href="https://developer.salesforce.com/docs/" target="_blank">Salesforce Developer Guide</a></li>
                <li><a href="https://trailhead.salesforce.com/content/learn/modules/prompt-builder-basics" target="_blank">Trailhead: Prompt Builder Basics</a></li>
            </ul>
            <p>Keep exploring, keep building, and happy coding!</p>
        </div>

        <div class="slide" id="slide10">
            <h2>Appendix: For Your Reference ‚ÑπÔ∏è</h2>
            <p>This section provides information for your future projects beyond this lab's simplified setup.</p>
            <h3>A. How to Obtain Your Own Google Gemini API Key</h3>
            <ol>
                <li>Go to <a href="https://makersuite.google.com/app/apikey" target="_blank">Google AI Studio</a>.</li>
                <li>Sign in with your Google account.</li>
                <li>You might need to enable the "Generative Language API" in a Google Cloud Project. Google AI Studio often guides you. Ensure billing is enabled for that project if required by Google Cloud for API usage beyond free tiers.</li>
                <li>In Google AI Studio, click "Get API key" then "Create API key".</li>
                <li>Copy the generated API key and store it securely.</li>
            </ol>

            <h3>B. Using Named Credentials in Salesforce (Best Practice)</h3>
            <p>Named Credentials securely manage authentication and endpoint details.</p>
            <ol>
                <li><strong>Store API Key Securely (Example):</strong> Use a Protected Custom Setting (e.g., `API_Keys__c` with a field `Gemini_Key__c`).</li>
                <li><strong>Create Named Credential:</strong>
                    <ul>
                        <li>Setup &gt; Named Credentials &gt; New.</li>
                        <li>**Label:** e.g., `My_Secure_Gemini_API`</li>
                        <li>**Name:** (Auto-filled)</li>
                        <li>**URL:** `https://generativelanguage.googleapis.com`</li>
                        <li>**Identity Type:** `Anonymous`</li>
                        <li>**Authentication Protocol:** `No Authentication`</li>
                        <li>**Custom Headers (Recommended for API Key):**
                            <ul>
                                <li>Header Name: `x-goog-api-key`</li>
                                <li>Header Value: Your actual API Key. (For production, retrieve this from a custom setting in Apex and set the header there, or use a formula if available for your setup.)</li>
                            </ul>
                        </li>
                        <li>Save.</li>
                    </ul>
                </li>
                <li><strong>Update Apex to Use Named Credential:</strong>
                    <div class="code-block-wrapper">
                        <button class="copy-code-button" aria-label="Copy Apex Named Credential Example">üìã Copy</button>
                        <pre><code class="language-apex">
// Example Apex using Named Credential
HttpRequest req = new HttpRequest();
// Endpoint uses 'callout:' + Named Credential Name
req.setEndpoint('callout:My_Secure_Gemini_API/v1beta/models/gemini-1.5-flash-latest:generateContent');
req.setMethod('POST');
req.setHeader('Content-Type', 'application/json; charset=utf-8');
// API key is handled by the Named Credential's custom header if configured there.
// Otherwise, retrieve from secure storage and set here:
// String apiKey = getApiKeyFromSecureStorage(); 
// req.setHeader('x-goog-api-key', apiKey); 
// ... rest of request body setup and callout ...
                        </code></pre>
                    </div>
                </li>
            </ol>
        </div>

    </div> <div class="navigation-buttons">
        <button id="prevBtn" onclick="changeSlide(-1)">‚ùÆ Previous</button>
        <button id="nextBtn" onclick="changeSlide(1)">Next ‚ùØ</button>
    </div>

    <script>
        // --- Slide Navigation Logic ---
        let currentSlide = 0;
        const slides = document.querySelectorAll('.slide');
        const totalSlides = slides.length;
        const prevButton = document.getElementById('prevBtn');
        const nextButton = document.getElementById('nextBtn');
        const progressBar = document.getElementById('progressBar');


        function updateProgressBar() {
            if (progressBar && totalSlides > 0) {
                const progressPercentage = ((currentSlide + 1) / totalSlides) * 100;
                progressBar.style.width = progressPercentage + '%';
            }
        }

        function showSlide(index) {
            if (!slides || slides.length === 0) { console.error("Slides not found."); return; }
            if (index < 0 || index >= totalSlides) { console.error("Invalid slide index:", index); return; }
            
            slides.forEach((slideEl, i) => {
                slideEl.classList.remove('active');
                if (i === index) { slideEl.classList.add('active'); }
            });
            currentSlide = index;
            updateNavButtons();
            updateProgressBar();


            // Simulation & Visuals is now Slide 5 (index 4)
            if (index === 4) { 
                startWorkflowAnimation();
            }
        }

        function changeSlide(step) {
            let newSlideIndex = currentSlide + step;
            if (newSlideIndex >= 0 && newSlideIndex < totalSlides) {
                showSlide(newSlideIndex);
            }
        }
        
        function updateNavButtons() {
            if (prevButton) { prevButton.disabled = (currentSlide === 0); }
            if (nextButton) { nextButton.disabled = (currentSlide === totalSlides - 1); }
        }
        
        // --- Copy Code Functionality ---
        function copyCode(buttonElement) {
            const wrapper = buttonElement.parentElement;
            const preElement = wrapper.querySelector('pre');
            
            if (preElement) {
                const codeElement = preElement.querySelector('code');
                if (codeElement) {
                    const codeToCopy = codeElement.textContent || "";
                    navigator.clipboard.writeText(codeToCopy).then(() => {
                        buttonElement.innerHTML = '‚úì Copied!'; // Use innerHTML for icon
                        buttonElement.classList.add('copied');
                        setTimeout(() => {
                            buttonElement.innerHTML = 'üìã Copy'; // Use innerHTML for icon
                            buttonElement.classList.remove('copied');
                        }, 2000);
                    }).catch(err => {
                        console.error('Failed to copy code: ', err);
                        buttonElement.textContent = 'Error';
                        setTimeout(() => { buttonElement.innerHTML = 'üìã Copy'; }, 2000);
                    });
                } else { console.error("Copy Code: <code> element not found inside <pre>.");}
            } else { console.error("Copy Code: <pre> element not found relative to button.");}
        }
        
        function initializeCopyButtons() {
            document.querySelectorAll('.copy-code-button').forEach(button => {
                button.innerHTML = 'üìã Copy'; // Initialize with icon
                button.onclick = null; 
                button.addEventListener('click', function() { copyCode(this); });
            });
        }


        document.addEventListener('DOMContentLoaded', () => {
            if (slides.length > 0) {
                if (prevButton && nextButton) { showSlide(0); } 
                else { console.error("Navigation buttons not found."); }
            } else {
                console.error("No slides found.");
                if(prevButton) prevButton.disabled = true;
                if(nextButton) nextButton.disabled = true;
            }
            
            const toggleBtn = document.getElementById('toggleSummaryBtn');
            const summaryView = document.getElementById('summaryAfterView');
            if (toggleBtn && summaryView) {
                 if (summaryView.style.display === 'none' || summaryView.style.display === '') {
                    toggleBtn.innerHTML = '‚ú® Show AI Summary Example'; // Use innerHTML for icon
                } else {
                    toggleBtn.textContent = 'Show Original Text';
                }
            }
            initializeCopyButtons(); 
        });

        function startWorkflowAnimation() {
            const svgContainer = d3.select("#workflowAnimation");
            svgContainer.selectAll("*").remove(); 
            const bounds = svgContainer.node()?.getBoundingClientRect();
            if (!bounds || bounds.width <= 0 || bounds.height <= 0) { console.warn("D3 container has no valid dimensions."); return; }
            const width = bounds.width; const height = bounds.height;
            const svg = svgContainer.append("svg").attr("width", width).attr("height", height).attr("viewBox", `0 0 ${width} ${height}`).style("overflow", "visible");
            const nodeRadius = Math.min(width, height) * 0.05; const fontSize = Math.min(width, height) * 0.025;
            const nodesData = [
                { id: 1, name: "User Clicks Summarise", x: width * 0.2, y: height * 0.3 }, { id: 2, name: "Apex Callout", x: width * 0.4, y: height * 0.3 },
                { id: 3, name: "SF Sends Request", x: width * 0.5, y: height * 0.15 }, { id: 4, name: "Gemini API Processes", x: width * 0.7, y: height * 0.15 },
                { id: 5, name: "Gemini Responds", x: width * 0.5, y: height * 0.85 }, { id: 6, name: "Apex Receives", x: width * 0.4, y: height * 0.7 },
                { id: 7, name: "Summary Displayed", x: width * 0.2, y: height * 0.7 }
            ];
            const linksData = [
                { source: nodesData[0], target: nodesData[1], label: "1. UI Event" }, { source: nodesData[1], target: nodesData[2], label: "2. To SF Server" },
                { source: nodesData[2], target: nodesData[3], label: "3. To Gemini" }, { source: nodesData[3], target: nodesData[4], label: "4. AI Response" },
                { source: nodesData[4], target: nodesData[5], label: "5. Back to SF" }, { source: nodesData[5], target: nodesData[6], label: "6. Update UI" }
            ];
            svg.append("defs").append("marker").attr("id", "arrow").attr("viewBox", "0 -5 10 10").attr("refX", nodeRadius * 0.7 + 5).attr("refY", 0).attr("markerWidth", 6).attr("markerHeight", 6).attr("orient", "auto-start-reverse").append("path").attr("d", "M0,-5L10,0L0,5").style("fill", "#555");
            const nodeElements = svg.selectAll("g.node").data(nodesData).enter().append("g").attr("class", "node").attr("transform", d => `translate(${d.x},${d.y})`);
            nodeElements.append("circle").attr("r", nodeRadius).style("fill", "#00A1E0").style("stroke", "#0070D2").style("stroke-width", 2);
            nodeElements.append("text").text(d => d.name).attr("x", 0).attr("y", nodeRadius + fontSize * 1.2).style("font-size", `${fontSize}px`).style("fill", "#333").style("text-anchor", "middle");
            let animationDelay = 0; const stepDuration = 1000; const highlightDuration = 500;
            linksData.forEach((link, i) => {
                const path = svg.append("line").attr("x1", link.source.x).attr("y1", link.source.y).attr("x2", link.source.x).attr("y2", link.source.y).attr("stroke", "#aaa").attr("stroke-width", 2).attr("marker-end", "url(#arrow)");
                const label = svg.append("text").text(link.label).attr("x", (link.source.x + link.target.x) / 2).attr("y", (link.source.y + link.target.y) / 2 - 5).style("font-size", `${fontSize*0.8}px`).style("fill", "#555").style("text-anchor", "middle").style("opacity",0);
                d3.select(nodeElements.nodes()[i]).select("circle").transition().delay(animationDelay).duration(highlightDuration).style("fill","orange"); animationDelay += highlightDuration;
                path.transition().delay(animationDelay).duration(stepDuration).attr("x2",link.target.x).attr("y2",link.target.y);
                label.transition().delay(animationDelay + stepDuration/2).duration(highlightDuration).style("opacity",1); animationDelay += stepDuration;
                d3.select(nodeElements.nodes()[i]).select("circle").transition().delay(animationDelay).duration(highlightDuration).style("fill","#5cb85c");
            });
            if(nodesData.length > 0 && nodeElements.nodes()[nodesData.length-1]){d3.select(nodeElements.nodes()[nodesData.length-1]).select("circle").transition().delay(animationDelay).duration(highlightDuration).style("fill","#5cb85c");}
        }
        
        function toggleSummaryView() {
            const originalView = document.getElementById('originalTextView');
            const summaryView = document.getElementById('summaryAfterView');
            const button = document.getElementById('toggleSummaryBtn');
            if (summaryView && originalView && button) {
                if (summaryView.style.display === 'none' || summaryView.style.display === '') {
                    originalView.style.display = 'none'; summaryView.style.display = 'block'; button.innerHTML = 'Show Original Text'; // Use innerHTML for icon
                } else {
                    originalView.style.display = 'block'; summaryView.style.display = 'none'; button.innerHTML = '‚ú® Show AI Summary Example'; // Use innerHTML for icon
                }
            }
        }
    </script>
</body>
</html>

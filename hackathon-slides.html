<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Salesforce Developer Lab Hackathon: Knowledge Companion</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            line-height: 1.6;
            margin: 0;
            padding: 0;
            background-color: #f4f7f9;
            color: #333;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .slide-container {
            width: 90%;
            max-width: 1000px;
            margin: 20px auto;
            background-color: #fff;
            border: 1px solid #ddd;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden; /* Ensures content within slides doesn't cause unexpected layout shifts */
        }

        .slide {
            display: none;
            padding: 30px 40px;
            min-height: 400px; /* Adjust as needed based on content */
            animation: fadeIn 0.5s ease-in-out;
        }

        .slide.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        h1, h2, h3, h4 {
            color: #003972; /* Salesforce Blue */
            margin-bottom: 0.75em;
        }
        h1 { font-size: 2.2em; text-align: center; margin-bottom: 1em; color: #001B35; }
        h2 { font-size: 1.8em; border-bottom: 2px solid #00A1E0; padding-bottom: 0.3em; margin-top: 1.5em;}
        h3 { font-size: 1.4em; margin-top: 1.2em; }
        h4 { font-size: 1.1em; font-style: italic; color: #555;}


        p, ul, ol {
            margin-bottom: 1em;
        }

        ul, ol {
            padding-left: 20px;
        }
        li { margin-bottom: 0.5em; }

        code {
            font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, Courier, monospace;
            background-color: #eef1f3;
            padding: 0.2em 0.4em;
            border-radius: 3px;
            font-size: 0.9em;
        }

        pre {
            background-color: #2d2d2d; /* Dark background for code blocks */
            color: #f8f8f2; /* Light text for contrast */
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 0.9em;
            line-height: 1.5;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        pre code {
            background-color: transparent;
            padding: 0;
            font-size: 1em; /* Reset font size for code inside pre */
            color: inherit; /* Inherit color from pre */
        }

        .navigation-buttons {
            display: flex;
            justify-content: space-between;
            padding: 20px 40px; /* Use consistent padding with slides */
            background-color: #f0f0f0;
            border-top: 1px solid #ccc;
            width: 90%; /* Match slide-container width */
            max-width: 1000px; /* Match slide-container max-width */
            box-sizing: border-box; /* Include padding and border in the element's total width and height */
            margin: 0 auto 20px auto; /* Center and add bottom margin */
        }

        .navigation-buttons button {
            background-color: #0070d2; /* Salesforce Button Blue */
            color: white;
            border: none;
            padding: 10px 20px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .navigation-buttons button:hover:not(:disabled) {
            background-color: #005fb2;
        }

        .navigation-buttons button:disabled {
            background-color: #c0c0c0;
            cursor: not-allowed;
        }

        .note {
            background-color: #fff3cd; /* Yellowish note */
            border-left: 5px solid #ffeeba;
            padding: 10px 15px;
            margin: 15px 0;
            border-radius: 3px;
        }
        .note strong { color: #856404; }

        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgb(0,0,0); /* Fallback color */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
        }

        .modal-content {
            background-color: #fefefe;
            margin: 15% auto; /* 15% from the top and centered */
            padding: 20px;
            border: 1px solid #888;
            width: 60%; /* Could be more or less, depending on screen size */
            border-radius: 8px;
            box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2),0 6px 20px 0 rgba(0,0,0,0.19);
        }
        .modal-content h3 { margin-top: 0;}

        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        /* D3 Animation container */
        #workflowAnimation {
            width: 100%;
            height: 400px; /* Adjust as needed */
            border: 1px solid #eee;
            margin-top: 20px;
            background-color: #f9f9f9;
        }
        #workflowAnimation svg { /* Ensure SVG takes full dimensions of its container */
            display: block; /* Removes any extra space below inline SVGs */
            width: 100%;
            height: 100%;
        }

        /* Before/After Toggle */
        .summary-toggle-container {
            margin-top: 20px;
            padding: 15px;
            background-color: #e9ecef;
            border-radius: 5px;
        }
        .summary-toggle-container button { margin-bottom: 10px;}
        .summary-text-area {
            border: 1px dashed #ccc;
            padding: 10px;
            min-height: 100px;
            background-color: #fff;
        }
        #summaryAfterView { display: none; } /* Initially hidden */

        /* Syntax highlighting (basic conceptual) */
        .token.keyword { color: #569cd6; font-weight: bold; }
        .token.string { color: #ce9178; }
        .token.comment { color: #6a9955; font-style: italic; }
        .token.punctuation { color: #d4d4d4; } /* Might be too light on dark, adjust if needed */
        .token.class-name { color: #4ec9b0; }
        .token.function { color: #dcdcaa; }
        .token.tag { color: #569cd6; }
        .token.attr-name { color: #9cdcfe; }
        .token.attr-value { color: #ce9178; }
        .token.annotation { color: #4ec9b0; } /* For Apex annotations */

    </style>
</head>
<body>

    <h1>🚀 Salesforce Developer Lab: Knowledge Companion - Document Summariser 📄</h1>

    <div class="slide-container">
        <div class="slide active" id="slide1">
            <h2>Lab Overview & Business Impact</h2>
            <h3>The Challenge: Information Overload 😩</h3>
            <p>In today's fast-paced environment, users are often confronted with vast amounts of text. Quickly understanding the essence of long documents like Salesforce <strong>Knowledge Articles</strong>, detailed <strong>Case Descriptions</strong>, or comprehensive <strong>Product Manuals</strong> is crucial but time-consuming.</p>

            <h3>The Solution: Knowledge Companion ✨</h3>
            <p>This lab guides you in building a "Knowledge Companion" tool. Powered by the <strong>Gemini API</strong>, this tool integrates directly into Salesforce to provide instant summaries of lengthy text content. This significantly enhances productivity by allowing users to grasp key information at a glance.</p>

            <h3>Real-Life Use Cases 💡</h3>
            <ul>
                <li><strong>Support Agents:</strong> Quickly summarize complex case histories or long knowledge articles to resolve issues faster.</li>
                <li><strong>Sales Teams:</strong> Get rapid summaries of account details, past communications, or opportunity notes.</li>
                <li><strong>Product Managers:</strong> Condense user feedback or technical documentation.</li>
                <li><strong>Any Salesforce User:</strong> Efficiently process information from lengthy text fields across various objects.</li>
            </ul>
        </div>

        <div class="slide" id="slide2">
            <h2>Lab Goal 🎯</h2>
            <p>By the end of this lab, you will have built a solution that can:</p>
            <ul>
                <li>Summarize content from a rich text area field (e.g., <code>Content__c</code>) on a Salesforce Knowledge Article.</li>
                <li>Trigger this summarization process via a custom Lightning Web Component (LWC) button ("AI Summarise") placed on the Knowledge Article page.</li>
                <li>Display the AI-generated summary clearly within a modal dialog on the screen.</li>
            </ul>
            <p>This hands-on experience will cover Salesforce configuration, Apex development for API callouts, and LWC creation for a seamless user interface.</p>
        </div>

        <div class="slide" id="slide3">
            <h2>Step 1: Salesforce Org Setup ⚙️</h2>
            <p>First, let's prepare your Salesforce Developer Org.</p>

            <h3>1. Enable Salesforce Knowledge</h3>
            <ul>
                <li>Navigate to <strong>Setup</strong> > <strong>Knowledge</strong> > <strong>Knowledge Settings</strong>.</li>
                <li>If not already enabled, check "Yes, I'd like to enable Salesforce Knowledge" and follow the setup wizard. You might need to assign licenses and permissions to your user.</li>
            </ul>

            <h3>2. Add Custom Field to Knowledge Object</h3>
            <p>We need a field on the Knowledge Article object (<code>Knowledge__kav</code>) to hold the content you want to summarize. If you already have a rich text field with your main content, you can use that. Otherwise, create a new one:</p>
            <ul>
                <li>Navigate to <strong>Setup</strong> > <strong>Object Manager</strong> > <strong>Knowledge</strong>.</li>
                <li>Go to <strong>Fields & Relationships</strong> and click <strong>New</strong>.</li>
                <li>Select Data Type: <strong>Text Area (Rich)</strong> or <strong>Text Area (Long)</strong>. Click Next.</li>
                <li>Field Label: e.g., <code>Content for Summarization</code></li>
                <li>Field Name: e.g., <code>Content_for_Summarization__c</code> (The prompt suggested <code>Content__c</code>, ensure you use a consistent API name. For this guide, let's use <code>Content_for_Summarization__c</code> to be explicit).</li>
                <li>Complete the field creation wizard (visible to appropriate profiles, add to page layouts).</li>
            </ul>
             <div class="note">
                <strong>Note:</strong> The standard Knowledge object has fields like `Answer__c` (for Q&A) or you might use a custom rich text field that's part of your article type. Identify the API name of the field containing the main text you wish to summarize.
            </div>

            <h3>3. API Access and User Permissions</h3>
            <ul>
                <li>Ensure your user profile has "API Enabled" system permission.</li>
                <li>Ensure your user has CRUD permissions on the Knowledge object and the custom field.</li>
            </ul>
        </div>

        <div class="slide" id="slide4">
            <h2>Step 2: Gemini API Configuration 🔑</h2>
            <p>Now, let's set up access to the Google Gemini API.</p>

            <h3>1. Get Your Gemini API Key</h3>
            <ul>
                <li>Go to <a href="https://makersuite.google.com/app/apikey" target="_blank">Google AI Studio (formerly MakerSuite)</a>.</li>
                <li>Sign in with your Google account.</li>
                <li>Click on "Get API key" and then "Create API key in new project" (or use an existing one).</li>
                <li>Copy your API key and store it securely. <strong>This key is sensitive!</strong></li>
            </ul>

            <h3>2. Create a Named Credential in Salesforce</h3>
            <p>Named Credentials simplify authenticated callouts from Salesforce.</p>
            <ul>
                <li>In Salesforce Setup, search for "Named Credentials".</li>
                <li>Click <strong>New Named Credential</strong>.
                    <ul>
                        <li><strong>Label:</strong> <code>Google Gemini API</code></li>
                        <li><strong>Name:</strong> <code>Google_Gemini_API</code> (This will be auto-filled from label)</li>
                        <li><strong>URL:</strong> <code>https://generativelanguage.googleapis.com</code></li>
                        <li><strong>Identity Type:</strong> <code>Anonymous</code> (We will add the API key via a header in Apex for this lab's simplicity. For production, explore options like `Password Authentication` with the API key in the password field and using custom headers, or storing the key in Protected Custom Settings/Metadata and constructing the header in Apex).</li>
                        <li><strong>Authentication Protocol:</strong> <code>No Authentication</code></li>
                        <li><strong>Generate Authorization Header:</strong> Unchecked</li>
                        <li>Leave other fields as default unless you have specific network configurations.</li>
                    </ul>
                </li>
                <li>Click <strong>Save</strong>.</li>
            </ul>

            <h3>3. Securely Storing and Accessing the API Key (Important Note)</h3>
            <div class="note">
                <p>For this hackathon lab, you might be tempted to hardcode the API key in your Apex class. <strong>Avoid this in real projects!</strong></p>
                <p><strong>Better approach for this lab (and closer to best practice):</strong></p>
                <ol>
                    <li>Create a Custom Setting:
                        <ul>
                            <li>Setup > Custom Settings > New.</li>
                            <li>Label: `Gemini API Config`, Object Name: `Gemini_API_Config`. Setting Type: `Hierarchy`.</li>
                            <li>Add a new custom field: Data Type: `Text`, Field Label: `API Key`, Field Name: `API_Key__c`. Make it long enough.</li>
                            <li>Manage the Custom Setting records and input your API key there.</li>
                        </ul>
                    </li>
                    <li>In your Apex code, you'll retrieve it like this: <code>Gemini_API_Config__c.getOrgDefaults().API_Key__c;</code></li>
                </ol>
                <p>For ultimate security in production, consider Protected Custom Settings/Metadata, or integrate with a secrets management system.</p>
            </div>
        </div>

        <div class="slide" id="slide5">
            <h2>Step 3: Apex Code Walkthrough 👨‍💻</h2>
            <p>Let's create an Apex class to communicate with the Gemini API.</p>

            <h3>1. Create Apex Class: <code>GeminiAPIService</code></h3>
            <p>This class will handle the callout to the Gemini API.</p>
            <pre><code class="language-apex">
// GeminiAPIService.cls
public with sharing class GeminiAPIService {

    // Replace with your Custom Setting name if you used one
    private static String getApiKey() {
        // OPTION 1: Using a Hierarchy Custom Setting (Recommended for Lab)
        /*
        Gemini_API_Config__c config = Gemini_API_Config__c.getOrgDefaults();
        if (config != null && String.isNotBlank(config.API_Key__c)) {
            return config.API_Key__c;
        }
        System.debug(Logginglevel.ERROR, 'API Key not found in Custom Setting Gemini_API_Config__c');
        return null; // Or throw an error
        */

        // OPTION 2: Placeholder for direct input (NOT FOR PRODUCTION - REPLACE THIS)
        // Remember to replace 'YOUR_GEMINI_API_KEY_HERE' with your actual key for testing.
        // For the lab, ensure participants understand this is for temporary testing only.
        String apiKey = 'YOUR_GEMINI_API_KEY_HERE'; 
        if (apiKey == 'YOUR_GEMINI_API_KEY_HERE' || String.isBlank(apiKey)) {
            System.debug(LoggingLevel.ERROR, 'API Key is a placeholder or blank. Please configure it.');
            // In a real app, you'd throw an exception or handle this more gracefully.
            // For the lab, returning an error message the LWC can display is one option.
            // throw new AuraHandledException('API Key not configured.'); // This would go to LWC catch block
        }
        return apiKey;
    }

    @AuraEnabled(cacheable=false) // Use cacheable=false for methods that perform DML or callouts
    public static String getSummary(Id recordId, String textToSummarize) {
        if (String.isBlank(textToSummarize)) {
            System.debug('GeminiAPIService: No content provided for summarization for recordId: ' + recordId);
            return 'Error: No content provided for summarization.';
        }

        String apiKey = getApiKey();
        if (String.isBlank(apiKey) || apiKey == 'YOUR_GEMINI_API_KEY_HERE') { // Check against placeholder
            System.debug('GeminiAPIService: API Key not configured or is placeholder.');
            return 'Error: API Key not configured properly.';
        }

        HttpRequest request = new HttpRequest();
        // Using Named Credential URL + path for Gemini Flash 1.5
        // The '/v1beta/models/gemini-1.5-flash:generateContent' is the specific endpoint path.
        // The Named Credential 'Google_Gemini_API' handles the base URL 'https://generativelanguage.googleapis.com'
        request.setEndpoint('callout:Google_Gemini_API/v1beta/models/gemini-1.5-flash:generateContent');
        request.setMethod('POST');
        request.setHeader('Content-Type', 'application/json; charset=utf-8');
        request.setHeader('x-goog-api-key', apiKey); // API Key in header as per Gemini requirements

        // Construct the request body for Gemini API
        Map<String, Object> contentPart = new Map<String, Object>{
            'text' => textToSummarize
        };
        Map<String, Object> contentsMap = new Map<String, Object>{
            'parts' => new List<Object>{contentPart}
        };
        Map<String, Object> requestBodyMap = new Map<String, Object>{
            'contents' => new List<Object>{contentsMap}
        };
        
        // Optional: Add generationConfig for more control (e.g. maxOutputTokens, temperature)
        // Map<String, Object> generationConfig = new Map<String, Object>{
        //    'maxOutputTokens' => 150, // Example: limit summary length
        //    'temperature' => 0.7      // Example: control creativity
        // };
        // requestBodyMap.put('generationConfig', generationConfig);

        request.setBody(JSON.serialize(requestBodyMap));
        request.setTimeout(60000); // 60 seconds timeout, adjust as needed

        Http http = new Http();
        String summary = '';

        try {
            HttpResponse response = http.send(request);
            System.debug('Gemini API Response Status Code: ' + response.getStatusCode());
            System.debug('Gemini API Response Body: ' + response.getBody());

            if (response.getStatusCode() == 200) {
                Map<String, Object> result = (Map<String, Object>) JSON.deserializeUntyped(response.getBody());
                
                List<Object> candidates = (List<Object>) result.get('candidates');
                if (candidates != null && !candidates.isEmpty()) {
                    Map<String, Object> firstCandidate = (Map<String, Object>) candidates[0];
                    Map<String, Object> content = (Map<String, Object>) firstCandidate.get('content');
                    if (content != null) {
                        List<Object> parts = (List<Object>) content.get('parts');
                        if (parts != null && !parts.isEmpty()) {
                            Map<String, Object> firstPart = (Map<String, Object>) parts[0];
                            summary = (String) firstPart.get('text');
                        } else {
                             summary = 'Error: No summary content parts found in response.';
                             System.debug('GeminiAPIService: No parts in content. Response: ' + response.getBody());
                        }
                    } else {
                        summary = 'Error: No content object in candidate. Response: ' + response.getBody();
                        System.debug('GeminiAPIService: No content in candidate. Response: ' + response.getBody());
                    }
                } else {
                    summary = 'Error: No candidates found in API response.';
                    // Check for error structure in response if no candidates
                    Map<String, Object> errorResponse = (Map<String, Object>) result.get('error');
                    if(errorResponse != null && errorResponse.containsKey('message')) {
                        summary += ' API Error: ' + errorResponse.get('message');
                    }
                    System.debug('GeminiAPIService: No candidates in response. Full Body: ' + response.getBody());
                }
            } else {
                summary = 'Error: API call failed with status ' + response.getStatusCode() + ' - ' + response.getStatus();
                summary += '. Response: ' + response.getBody(); // Include API error message if possible
                System.debug('Error from Gemini API: Status=' + response.getStatusCode() + ', Body=' + response.getBody());
            }
        } catch (Exception e) {
            summary = 'Error: Exception during API call - ' + e.getMessage();
            System.debug(LoggingLevel.ERROR, 'GeminiAPIService Exception: ' + e.getMessage() + ' Stacktrace: ' + e.getStackTraceString());
            // For LWC, throwing AuraHandledException is a good practice for client-side error handling
            // throw new AuraHandledException('Failed to connect to summarization service: ' + e.getMessage());
        }
        // Basic HTML tag stripping. For more robust sanitization, consider alternatives.
        return summary != null ? summary.stripHtmlTags() : 'Error: Received null summary.';
    }
}
            </code></pre>
            <h3>Key Points:</h3>
            <ul>
                <li><strong><code>@AuraEnabled(cacheable=false)</code></strong>: Makes the method callable from an LWC. <code>cacheable=false</code> is needed because it performs a callout.</li>
                <li><strong>API Key Retrieval</strong>: Shows how to get the API key (ideally from Custom Settings). **Ensure 'YOUR_GEMINI_API_KEY_HERE' is replaced or the Custom Setting method is implemented.**</li>
                <li><strong>Named Credential</strong>: Uses <code>callout:Google_Gemini_API/...</code> syntax.</li>
                <li><strong>Request Body</strong>: Constructs the JSON payload required by the Gemini API (<code>gemini-1.5-flash</code> model).</li>
                <li><strong><code>x-goog-api-key</code> header</strong>: This is where the API key is passed.</li>
                <li><strong>JSON Deserialization</strong>: Parses the API response to extract the summary. The structure is based on Gemini API responses; always verify with current API documentation. Includes more detailed debugs and checks for common missing parts in the response.</li>
                <li><strong>Error Handling</strong>: Basic try-catch block with more verbose logging.</li>
                <li><strong>Timeout</strong>: Set to 60 seconds; adjust as needed.</li>
            </ul>
             <div class="note">
                <strong>Field to Summarize:</strong> The current Apex method takes <code>textToSummarize</code> as a parameter. Your LWC will be responsible for fetching this text from the Knowledge Article record.
            </div>
        </div>

        <div class="slide" id="slide6">
            <h2>Step 4: Lightning Web Component (LWC) ⚡</h2>
            <p>Create an LWC named <code>knowledgeCompanion</code> to trigger the summarization and display results.</p>

            <h3>1. <code>knowledgeCompanion.html</code></h3>
            <pre><code class="language-html">
&lt;template&gt;
    &lt;lightning-card title="Knowledge Companion: AI Summariser" icon-name="utility:summarydetail"&gt;
        &lt;div class="slds-p-around_medium"&gt;
            &lt;lightning-button
                label="AI Summarise Content"
                variant="brand"
                onclick={handleSummariseClick}
                disabled={isLoading}
                icon-name="utility:magicwand"&gt;
            &lt;/lightning-button&gt;

            &lt;template if:true={isLoading}&gt;
                &lt;div class="slds-m-top_medium slds-is-relative" style="height: 50px;"&gt; &lt;!-- Added height for spinner positioning --&gt;
                    &lt;lightning-spinner alternative-text="Loading..." size="medium"&gt;&lt;/lightning-spinner&gt;
                    &lt;!-- &lt;p&gt;Generating summary, please wait...&lt;/p&gt; --&gt; &lt;!-- Spinner implies waiting --&gt;
                &lt;/div&gt;
            &lt;/template&gt;

            &lt;template if:true={error}&gt;
                &lt;div class="slds-m-top_medium slds-text-color_error"&gt;
                    &lt;p&gt;&lt;strong&gt;Error:&lt;/strong&gt; {error}&lt;/p&gt;
                &lt;/div&gt;
            &lt;/template&gt;
        &lt;/div&gt;
    &lt;/lightning-card&gt;

    &lt;!-- Modal for displaying summary --&gt;
    &lt;template if:true={isModalOpen}&gt;
        &lt;section role="dialog" tabindex="-1" aria-modal="true" aria-labelledby="modal-heading-01" class="slds-modal slds-fade-in-open"&gt;
            &lt;div class="slds-modal__container"&gt;
                &lt;header class="slds-modal__header"&gt;
                    &lt;button class="slds-button slds-button_icon slds-modal__close slds-button_icon-inverse" title="Close" onclick={closeModal}&gt;
                        &lt;lightning-icon icon-name="utility:close" alternative-text="Close" variant="inverse" size="small"&gt;&lt;/lightning-icon&gt;
                        &lt;span class="slds-assistive-text"&gt;Close&lt;/span&gt;
                    &lt;/button&gt;
                    &lt;h2 id="modal-heading-01" class="slds-modal__title slds-hyphenate"&gt;AI Generated Summary&lt;/h2&gt;
                &lt;/header&gt;
                &lt;div class="slds-modal__content slds-p-around_medium" id="modal-content-id-1"&gt;
                    &lt;p style="white-space: pre-wrap;"&gt;{summaryText}&lt;/p&gt;
                &lt;/div&gt;
                &lt;footer class="slds-modal__footer"&gt;
                    &lt;lightning-button label="Close" title="Close" onclick={closeModal}&gt;&lt;/lightning-button&gt;
                &lt;/footer&gt;
            &lt;/div&gt;
        &lt;/section&gt;
        &lt;div class="slds-backdrop slds-backdrop_open" role="presentation"&gt;&lt;/div&gt;
    &lt;/template&gt;
&lt;/template&gt;
            </code></pre>

            <h3>2. <code>knowledgeCompanion.js</code></h3>
            <pre><code class="language-javascript">
import { LightningElement, api, wire, track } from 'lwc';
import { getRecord, getFieldValue } from 'lightning/uiRecordApi';
import getSummary from '@salesforce/apex/GeminiAPIService.getSummary';

// IMPORTANT: Replace 'Knowledge__kav.Content_for_Summarization__c' 
// with the actual API name of the field on your Knowledge Article object 
// that contains the text you want to summarize.
// Examples: 
// - Custom Rich Text Field: 'Knowledge__kav.My_Rich_Text_Content__c'
// - Standard Answer field for FAQ Article Type: 'Knowledge__kav.Answer__c'
// Check Object Manager > Knowledge > Fields & Relationships for the correct API name.
import KNOWLEDGE_CONTENT_FIELD from '@salesforce/schema/Knowledge__kav.Content_for_Summarization__c'; 

export default class KnowledgeCompanion extends LightningElement {
    @api recordId; // Automatically populated when LWC is on a record page

    @track summaryText = '';
    @track isLoading = false;
    @track error;
    @track isModalOpen = false;

    _wiredArticleData; // To store the raw wired data

    // Wire adapter to get the content from the Knowledge Article record
    @wire(getRecord, { recordId: '$recordId', fields: [KNOWLEDGE_CONTENT_FIELD] })
    wiredArticle({ error, data }) {
        if (data) {
            this._wiredArticleData = data; // Store data
            this.error = undefined; // Clear previous errors
        } else if (error) {
            console.error('Error wiring article data:', JSON.stringify(error));
            this.error = 'Failed to load article content. Ensure field API name is correct and you have access.';
            this._wiredArticleData = undefined;
        }
    }

    get articleContent() {
        if (this._wiredArticleData) {
            return getFieldValue(this._wiredArticleData, KNOWLEDGE_CONTENT_FIELD);
        }
        return undefined;
    }

    async handleSummariseClick() {
        this.isLoading = true;
        this.error = undefined;
        this.summaryText = '';

        const contentToSummarize = this.articleContent;

        if (!contentToSummarize || String(contentToSummarize).trim() === '') {
            this.error = 'No content found in the specified field (' + KNOWLEDGE_CONTENT_FIELD.fieldApiName + ') to summarize, or field is empty.';
            this.isLoading = false;
            return;
        }
        
        // Basic HTML stripping. For complex HTML, consider a more robust library or server-side cleaning.
        let plainTextContent = this.stripHtml(String(contentToSummarize)); // Ensure it's a string

        if (!plainTextContent || plainTextContent.trim() === '') {
            this.error = 'Content became empty after attempting to strip HTML. Original may have only contained HTML tags.';
            this.isLoading = false;
            return;
        }


        try {
            // Pass recordId (optional, if Apex needs it for context) and the processed text content
            const result = await getSummary({ recordId: this.recordId, textToSummarize: plainTextContent });
            
            if (result) {
                if (result.toLowerCase().startsWith('error:')) {
                    this.error = result;
                    console.error('Apex returned error:', result);
                } else {
                    this.summaryText = result;
                    this.isModalOpen = true; // Open modal only on success
                }
            } else {
                this.error = 'Received an empty response from the summarization service.';
                console.error('Apex returned empty or null result.');
            }
        } catch (e) {
            console.error('Error calling Apex getSummary:', JSON.stringify(e));
            this.error = (e.body && e.body.message) ? e.body.message : (e.message || 'An unknown error occurred while calling the summarization service.');
        } finally {
            this.isLoading = false;
        }
    }
    
    stripHtml(html) {
        if (!html) return "";
        // A more robust way to strip HTML in JS if DOMParser is available
        try {
            let doc = new DOMParser().parseFromString(html, 'text/html');
            return doc.body.textContent || "";
        } catch (e) {
            console.warn("DOMParser not available or failed, falling back to basic regex for HTML stripping.", e);
            // Basic regex fallback (less reliable for complex HTML)
            return html.replace(/<[^>]*>?/gm, '');
        }
    }

    openModal() { // This function isn't directly called by a button in this version, but good to have
        this.isModalOpen = true;
    }

    closeModal() {
        this.isModalOpen = false;
        this.summaryText = ''; // Optionally clear summary on close
    }
}
            </code></pre>

            <h3>3. <code>knowledgeCompanion.js-meta.xml</code></h3>
            <pre><code class="language-xml">
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;LightningComponentBundle xmlns="http://soap.sforce.com/2006/04/metadata"&gt;
    &lt;apiVersion&gt;59.0&lt;/apiVersion&gt; &lt;!-- Or your current org's API version --&gt;
    &lt;isExposed&gt;true&lt;/isExposed&gt;
    &lt;targets&gt;
        &lt;target&gt;lightning__RecordPage&lt;/target&gt;
    &lt;/targets&gt;
    &lt;targetConfigs&gt;
        &lt;targetConfig targets="lightning__RecordPage"&gt;
            &lt;objects&gt;
                &lt;object&gt;Knowledge__kav&lt;/object&gt; 
                &lt;!-- Add other SObject API names here if you want to use this LWC on other record pages --&gt;
            &lt;/objects&gt;
        &lt;/targetConfig&gt;
    &lt;/targetConfigs&gt;
&lt;/LightningComponentBundle&gt;
            </code></pre>
            <h3>Key LWC Points:</h3>
            <ul>
                <li><strong><code>@api recordId</code></strong>: Gets the current record's ID.</li>
                <li><strong><code>@wire(getRecord, ...)</code></strong>: Fetches the content from the specified field on the Knowledge Article. **Crucially, update <code>KNOWLEDGE_CONTENT_FIELD</code> to point to the correct API name of the rich text field you want to summarize.** Includes better error handling for the wire service.</li>
                <li><strong><code>stripHtml()</code></strong>: A utility to remove HTML tags from rich text content. Uses DOMParser with a regex fallback.</li>
                <li><strong><code>handleSummariseClick()</code></strong>: Calls the Apex <code>getSummary</code> method with improved error checking.</li>
                <li><strong><code>isLoading</code>, <code>error</code>, <code>isModalOpen</code></strong>: Trackers for UI state.</li>
                <li><strong>SLDS Modal</strong>: Uses standard SLDS markup for the modal display.</li>
                <li><strong>XML Configuration</strong>: Exposes the LWC for Lightning Record Pages, specifically for the <code>Knowledge__kav</code> object.</li>
            </ul>
            <p>After deploying these files to your Salesforce org, add the LWC to your Knowledge Article Lightning Record Page via the Lightning App Builder.</p>
        </div>

        <div class="slide" id="slide7">
            <h2>Step 5: Simulation & Visuals 📊</h2>

            <h3>Workflow Animation (Conceptual D3.js)</h3>
            <p>This D3.js animation visualizes the data flow when you click "AI Summarise". Click the button below the animation to replay it.</p>
            <div id="workflowAnimation"></div>
            <button onclick="startWorkflowAnimation()" class="slds-button slds-button_neutral slds-m-top_small">Replay Animation</button>

            <h3 class="slds-m-top_large">Before/After Summary View (Interactive Toggle)</h3>
            <div class="summary-toggle-container">
                <p>Simulate how a long piece of text can be condensed. Click the button to toggle between the original content and its summary.</p>
                <button id="toggleSummaryBtn" onclick="toggleSummaryView()" class="slds-button slds-button_brand">Show AI Summary Example</button>
                <div id="originalTextView" class="summary-text-area">
                    <h4>Original Document Text (Example)</h4>
                    <p>The Q4 Global Sales Initiative, codenamed "Project Everest," aims to expand market penetration in emerging APAC regions by 15% and increase overall recurring revenue by 10% through strategic partnerships and a revamped digital marketing strategy. Key performance indicators (KPIs) will include new customer acquisition rates, average deal size, and customer lifetime value. The initiative will involve cross-functional teams from Sales, Marketing, and Product Development, with a projected timeline of six months, starting January 1st. Bi-weekly progress reports will be submitted to the executive leadership team, outlining achievements, challenges, and mitigation strategies. A dedicated budget of $2.5 million has been allocated for this initiative, covering marketing campaigns, sales incentives, and technology upgrades. Training sessions for the sales team on new product features and market positioning are scheduled for mid-December. The success of Project Everest is critical for achieving the company's annual growth targets and strengthening its competitive position in the global market. All team members are expected to fully commit to their roles and responsibilities to ensure the project's objectives are met within the stipulated timeframe and budget.</p>
                </div>
                <div id="summaryAfterView" class="summary-text-area">
                    <h4>AI Generated Summary (Example)</h4>
                    <p>"Project Everest," a 6-month, $2.5M Q4 initiative, targets a 15% APAC market expansion and 10% recurring revenue growth via partnerships and digital marketing. KPIs include customer acquisition, deal size, and lifetime value. Cross-functional teams will report bi-weekly to executives. Success is vital for annual growth and market position.</p>
                </div>
            </div>
            <div class="note slds-m-top_medium">
                The D3.js animation script below is conceptual. You would typically refine positions, timing, and appearance further. It's designed to run when this slide becomes active or when the "Replay Animation" button is clicked.
            </div>
        </div>

        <div class="slide" id="slide8">
            <h2>Congratulations & Next Steps 🎉</h2>
            <p>You've successfully built a "Knowledge Companion" that leverages the power of Generative AI within Salesforce!</p>

            <h3>What You've Accomplished 🏆</h3>
            <ul>
                <li><strong>AI Integration:</strong> Connected Salesforce to the Google Gemini API for advanced text summarization.</li>
                <li><strong>Custom UI/UX:</strong> Developed a Lightning Web Component (LWC) to provide a user-friendly interface for triggering AI summaries.</li>
                <li><strong>Apex Callouts:</strong> Implemented Apex code to securely call external APIs using Named Credentials.</li>
                <li><strong>LWC-Apex Communication:</strong> Mastered how LWCs interact with Apex controllers to fetch and process data.</li>
                <li><strong>Practical Application:</strong> Gained hands-on experience in solving a real-world problem – information overload – using cutting-edge AI.</li>
            </ul>

            <h3>Potential Project Implementations & Enhancements 🚀</h3>
            <p>Think about how you can adapt or extend this project:</p>
            <ul>
                <li><strong>Summarize Other Objects:</strong> Apply this to Cases (description, comments), Accounts (notes, call logs), Emails, or Chatter threads.</li>
                <li><strong>Batch Summarization:</strong> Create a batch Apex job to summarize many records overnight.</li>
                <li><strong>Custom Prompts:</strong> Allow users to provide custom instructions to the AI for different summarization styles (e.g., "summarize for an executive," "extract key action items").</li>
                <li><strong>Sentiment Analysis:</strong> Extend the API call to also perform sentiment analysis on the text.</li>
                <li><strong>Record Update:</strong> Option to save the summary back to a field on the record.</li>
                <li><strong>Flow Integration:</strong> Trigger summarization from a Salesforce Flow.</li>
            </ul>

            <h3>Further Reading & Resources 📚</h3>
            <ul>
                <li><a href="https://ai.google.dev/docs/gemini_api_overview" target="_blank">Google Gemini API Documentation</a></li>
                <li><a href="https://ai.google.dev/models/gemini" target="_blank">Google Gemini Models (including Flash 1.5)</a></li>
                <li><a href="https://developer.salesforce.com/docs/" target="_blank">Salesforce Developer Guide</a></li>
                <li><a href="https://developer.salesforce.com/docs/component-library/documentation/en/lwc" target="_blank">Lightning Web Components Dev Guide</a></li>
                <li><a href="https://trailhead.salesforce.com/en/content/learn/modules/apex_integration_services" target="_blank">Trailhead: Apex Integration Services</a></li>
                <li><a href="https://trailhead.salesforce.com/en/content/learn/trails/build-lightning-web-components" target="_blank">Trailhead: Build Lightning Web Components</a></li>
            </ul>
            <p>Keep exploring, keep building, and happy coding!</p>
        </div>
    </div>

    <div class="navigation-buttons">
        <button id="prevBtn" onclick="changeSlide(-1)">❮ Previous</button>
        <button id="nextBtn" onclick="changeSlide(1)">Next ❯</button>
    </div>

    <script>
        // --- Slide Navigation Logic ---
        let currentSlide = 0;
        const slides = document.querySelectorAll('.slide');
        const totalSlides = slides.length;
        const prevButton = document.getElementById('prevBtn');
        const nextButton = document.getElementById('nextBtn');

        function showSlide(index) {
            if (index < 0 || index >= totalSlides) {
                console.error("Invalid slide index:", index);
                return;
            }
            slides.forEach((slide, i) => {
                slide.classList.remove('active');
                if (i === index) {
                    slide.classList.add('active');
                }
            });
            currentSlide = index;
            updateNavButtons();

            // If slide 7 (0-indexed as 6) is active, initialize or restart its specific animations
            if (index === 6) { // Slide 7 is at index 6
                startWorkflowAnimation(); // D3 animation
            }
        }

        function changeSlide(step) {
            let newSlideIndex = currentSlide + step;
            // No need to check bounds here, showSlide will handle it,
            // but updateNavButtons relies on currentSlide being within bounds.
            if (newSlideIndex >= 0 && newSlideIndex < totalSlides) {
                showSlide(newSlideIndex);
            }
        }
        
        function updateNavButtons() {
            if (prevButton) {
                prevButton.disabled = currentSlide === 0;
            }
            if (nextButton) {
                nextButton.disabled = currentSlide === totalSlides - 1;
            }
        }

        // Initialize first slide and button states on page load
        document.addEventListener('DOMContentLoaded', () => {
            if (slides.length > 0) {
                showSlide(0);
            } else {
                console.error("No slides with class '.slide' found. Navigation will not work.");
                if(prevButton) prevButton.disabled = true;
                if(nextButton) nextButton.disabled = true;
            }
             // Initial state for summary toggle button text
            const toggleBtn = document.getElementById('toggleSummaryBtn');
            const summaryView = document.getElementById('summaryAfterView');
            if (toggleBtn && summaryView) {
                 if (summaryView.style.display === 'none' || summaryView.style.display === '') {
                    toggleBtn.textContent = 'Show AI Summary Example';
                } else {
                    toggleBtn.textContent = 'Show Original Text';
                }
            }
        });

        // --- Slide 7: D3.js Workflow Animation ---
        function startWorkflowAnimation() {
            const svgContainer = d3.select("#workflowAnimation");
            svgContainer.selectAll("*").remove(); // Clear previous animation if any

            const bounds = svgContainer.node().getBoundingClientRect();
            const width = bounds.width;
            const height = bounds.height; // Ensure height is correctly determined

            if (width <= 0 || height <= 0) { // Don't draw if container has no size
                console.warn("D3 animation container has no dimensions. Skipping animation.");
                return;
            }
            
            const svg = svgContainer.append("svg")
                .attr("width", width)
                .attr("height", height)
                .attr("viewBox", `0 0 ${width} ${height}`) // Ensures responsiveness
                .style("overflow", "visible"); // Helps if markers go slightly out

            const nodeRadius = Math.min(width, height) * 0.05; // Dynamic radius
            const fontSize = Math.min(width, height) * 0.025; // Dynamic font size

            const nodes = [
                { id: 1, name: "User Clicks Summarise (LWC)", x: width * 0.2, y: height * 0.3 },
                { id: 2, name: "Apex Callout", x: width * 0.4, y: height * 0.3 },
                { id: 3, name: "Salesforce Sends Request", x: width * 0.5, y: height * 0.15 },
                { id: 4, name: "Gemini API Processes", x: width * 0.7, y: height * 0.15 },
                { id: 5, name: "Gemini Responds", x: width * 0.5, y: height * 0.85 },
                { id: 6, name: "Apex Receives Response", x: width * 0.4, y: height * 0.7 },
                { id: 7, name: "Summary Displayed (LWC Modal)", x: width * 0.2, y: height * 0.7 }
            ];

            const links = [
                { source: nodes[0], target: nodes[1], label: "1. UI Event" },
                { source: nodes[1], target: nodes[2], label: "2. To SF Server" },
                { source: nodes[2], target: nodes[3], label: "3. To Gemini" },
                { source: nodes[3], target: nodes[4], label: "4. AI Response" },
                { source: nodes[4], target: nodes[5], label: "5. Back to SF" },
                { source: nodes[5], target: nodes[6], label: "6. Update UI" }
            ];
            
            // Define arrow marker
            svg.append("defs").append("marker")
                .attr("id", "arrow")
                .attr("viewBox", "0 -5 10 10")
                .attr("refX", nodeRadius * 0.7 + 5) // Adjust refX based on node radius for better arrow positioning
                .attr("refY", 0)
                .attr("markerWidth", 6)
                .attr("markerHeight", 6)
                .attr("orient", "auto-start-reverse") // Changed orient for better arrow appearance
              .append("path")
                .attr("d", "M0,-5L10,0L0,5")
                .style("fill", "#555");


            const nodeElements = svg.selectAll("g.node")
                .data(nodes)
                .enter().append("g")
                .attr("class", "node")
                .attr("transform", d => `translate(${d.x},${d.y})`);

            nodeElements.append("circle")
                .attr("r", nodeRadius)
                .style("fill", "#00A1E0") // Initial color
                .style("stroke", "#0070D2")
                .style("stroke-width", 2);

            nodeElements.append("text")
                .text(d => d.name)
                .attr("x", 0) // Centered text
                .attr("y", nodeRadius + fontSize * 1.2) // Position below circle
                .style("font-size", `${fontSize}px`)
                .style("fill", "#333")
                .style("text-anchor", "middle");

            let animationDelay = 0;
            const stepDuration = 1000; // Duration for each line draw
            const highlightDuration = 500; // Duration for node highlight

            links.forEach((link, i) => {
                const path = svg.append("line")
                    .attr("x1", link.source.x)
                    .attr("y1", link.source.y)
                    .attr("x2", link.source.x) // Start with no length
                    .attr("y2", link.source.y)
                    .attr("stroke", "#aaa")
                    .attr("stroke-width", 2)
                    .attr("marker-end", "url(#arrow)");
                
                const label = svg.append("text")
                    .text(link.label)
                    .attr("x", (link.source.x + link.target.x) / 2)
                    .attr("y", (link.source.y + link.target.y) / 2 - 5)
                    .style("font-size", `${fontSize * 0.8}px`)
                    .style("fill", "#555")
                    .style("text-anchor", "middle")
                    .style("opacity", 0);

                // Highlight source node of the current link
                d3.select(nodeElements.nodes()[i]).select("circle")
                    .transition()
                    .delay(animationDelay)
                    .duration(highlightDuration)
                    .style("fill", "orange"); // Active color
                
                animationDelay += highlightDuration;

                // Animate path drawing
                path.transition()
                    .delay(animationDelay)
                    .duration(stepDuration)
                    .attr("x2", link.target.x)
                    .attr("y2", link.target.y);

                // Fade in label
                label.transition()
                    .delay(animationDelay + stepDuration / 2)
                    .duration(highlightDuration)
                    .style("opacity", 1);
                
                animationDelay += stepDuration;

                // Mark source node as completed, highlight target node for next step
                d3.select(nodeElements.nodes()[i]).select("circle")
                    .transition()
                    .delay(animationDelay) // After path is drawn
                    .duration(highlightDuration)
                    .style("fill", "#5cb85c"); // Completed color
            });
            
             // Final node (target of the last link) highlight as completed
            if (nodes.length > 0) {
                 d3.select(nodeElements.nodes()[nodes.length-1]).select("circle")
                    .transition()
                    .delay(animationDelay) // After last path is drawn
                    .duration(highlightDuration)
                    .style("fill", "#5cb85c"); // Completed color
            }
        }
        
        // --- Slide 7: Before/After Toggle ---
        function toggleSummaryView() {
            const originalView = document.getElementById('originalTextView');
            const summaryView = document.getElementById('summaryAfterView');
            const button = document.getElementById('toggleSummaryBtn'); // Use ID for button

            if (summaryView && originalView && button) { // Check if elements exist
                if (summaryView.style.display === 'none' || summaryView.style.display === '') {
                    originalView.style.display = 'none';
                    summaryView.style.display = 'block';
                    button.textContent = 'Show Original Text';
                } else {
                    originalView.style.display = 'block';
                    summaryView.style.display = 'none';
                    button.textContent = 'Show AI Summary Example';
                }
            } else {
                console.error("Summary toggle elements not found.");
            }
        }

        // --- Basic Syntax Highlighter (Conceptual - improves slightly on previous) ---
        function basicSyntaxHighlight() {
            document.querySelectorAll('pre code').forEach(block => {
                let html = block.textContent || ""; // Get raw text content to avoid re-processing HTML
                
                // Order of replacements matters: comments first, then strings, then keywords.
                // Comments (block and line)
                html = html.replace(/(\/\*[\s\S]*?\*\/|\/\/.*)/g, '<span class="token comment">$&</span>');
                
                // Strings (single and double quotes)
                html = html.replace(/('.*?'|".*?")/g, '<span class="token string">$&</span>');
                
                // Apex/Java-like keywords (case-sensitive)
                html = html.replace(/\b(public|private|static|void|String|Id|Map|List|if|else|for|while|try|catch|finally|return|new|with sharing|class|extends|implements|integer|boolean|true|false|null|this|super|@AuraEnabled|@api|@wire|@track|@TestVisible|@future|@InvocableMethod|@InvocableVariable|@IsTest)\b/g, '<span class="token keyword">$&</span>');
                
                // LWC/JS keywords
                html = html.replace(/\b(import|export|default|const|let|var|async|await|function|class|extends|constructor|get|set|=>|yield|from|of|this|super|true|false|null|undefined)\b/g, '<span class="token keyword">$&</span>');

                // Annotations (like @AuraEnabled but capture the whole thing)
                html = html.replace(/(@[A-Za-z_][A-Za-z0-9_]*(?:\s*\([\s\S]*?\))?)/g, '<span class="token annotation">$&</span>');
                
                // HTML tags in HTML code blocks (simplified for example)
                if (block.classList.contains('language-html') || block.classList.contains('language-xml')) {
                     // Match opening and closing tags
                    html = html.replace(/(&lt;\/?)([a-zA-Z0-9-]+)/g, '$1<span class="token tag">$2</span>');
                    // Match attributes (name="value")
                    html = html.replace(/([a-zA-Z0-9-]+)=(".*?"|'.*?')/g, '<span class="token attr-name">$1</span>=<span class="token attr-value">$2</span>');
                }

                block.innerHTML = html;
            });
        }
        // Apply basic syntax highlighting after DOM is loaded
        document.addEventListener('DOMContentLoaded', basicSyntaxHighlight);

    </script>
</body>
</html>
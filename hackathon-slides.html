<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Salesforce Developer Lab Hackathon: Knowledge Companion</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            line-height: 1.6;
            margin: 0;
            padding: 0;
            background-color: #f4f7f9;
            color: #333;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .slide-container {
            width: 90%;
            max-width: 1000px;
            margin: 20px auto;
            background-color: #fff;
            border: 1px solid #ddd;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .slide {
            display: none;
            padding: 30px 40px;
            min-height: 400px;
            animation: fadeIn 0.5s ease-in-out;
        }

        .slide.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        h1, h2, h3, h4 {
            color: #003972; /* Salesforce Blue */
            margin-bottom: 0.75em;
        }
        h1 { font-size: 2.2em; text-align: center; margin-bottom: 1em; color: #001B35; }
        h2 { font-size: 1.8em; border-bottom: 2px solid #00A1E0; padding-bottom: 0.3em; margin-top: 1.5em;}
        h3 { font-size: 1.4em; margin-top: 1.2em; }
        h4 { font-size: 1.1em; font-style: italic; color: #555;}


        p, ul, ol {
            margin-bottom: 1em;
        }

        ul, ol {
            padding-left: 20px;
        }
        li { margin-bottom: 0.5em; }

        code { /* For inline code */
            font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, Courier, monospace;
            background-color: #eef1f3;
            padding: 0.2em 0.4em;
            border-radius: 3px;
            font-size: 0.9em;
        }

        pre { /* For code blocks */
            background-color: #2d2d2d; /* Dark background */
            color: #f8f8f2; /* Light text */
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto; /* Allow horizontal scrolling for long lines */
            font-size: 0.85em; /* Slightly smaller for blocks */
            line-height: 1.5;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            white-space: pre; /* Preserve whitespace and line breaks */
        }
        pre code { /* Reset styles for <code> inside <pre> */
            background-color: transparent;
            padding: 0;
            font-size: 1em; 
            color: inherit; 
            white-space: inherit; 
        }

        .navigation-buttons {
            display: flex;
            justify-content: space-between;
            padding: 20px 40px;
            background-color: #f0f0f0;
            border-top: 1px solid #ccc;
            width: 90%;
            max-width: 1000px;
            box-sizing: border-box;
            margin: 0 auto 20px auto; /* Ensures it's centered like slide-container and has bottom margin */
        }

        .navigation-buttons button {
            background-color: #0070d2;
            color: white;
            border: none;
            padding: 10px 20px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .navigation-buttons button:hover:not(:disabled) {
            background-color: #005fb2;
        }

        .navigation-buttons button:disabled {
            background-color: #c0c0c0;
            cursor: not-allowed;
        }

        .note {
            background-color: #fff3cd;
            border-left: 5px solid #ffeeba;
            padding: 10px 15px;
            margin: 15px 0;
            border-radius: 3px;
        }
        .note strong { color: #856404; }

        .modal { 
            display: none; position: fixed; z-index: 1000;
            left: 0; top: 0; width: 100%; height: 100%;
            overflow: auto; background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe; margin: 15% auto; padding: 20px;
            border: 1px solid #888; width: 60%; border-radius: 8px;
            box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2),0 6px 20px 0 rgba(0,0,0,0.19);
        }
        .modal-content h3 { margin-top: 0;}

        #workflowAnimation {
            width: 100%; height: 400px; border: 1px solid #eee;
            margin-top: 20px; background-color: #f9f9f9;
        }
        #workflowAnimation svg { display: block; width: 100%; height: 100%;}

        .summary-toggle-container {
            margin-top: 20px; padding: 15px; background-color: #e9ecef; border-radius: 5px;
        }
        .summary-toggle-container button { margin-bottom: 10px;}
        .summary-text-area {
            border: 1px dashed #ccc; padding: 10px; min-height: 100px; background-color: #fff;
        }
        #summaryAfterView { display: none; }
    </style>
</head>
<body>

    <h1>üöÄ Salesforce Developer Lab: Knowledge Companion - Document Summariser üìÑ</h1>

    <div class="slide-container">
        <div class="slide active" id="slide1">
            <h2>Lab Overview & Business Impact</h2>
            <h3>The Challenge: Information Overload üò©</h3>
            <p>In today's fast-paced environment, users are often confronted with vast amounts of text. Quickly understanding the essence of long documents like Salesforce <strong>Knowledge Articles</strong>, detailed <strong>Case Descriptions</strong>, or comprehensive <strong>Product Manuals</strong> is crucial but time-consuming.</p>
            <h3>The Solution: Knowledge Companion ‚ú®</h3>
            <p>This lab guides you in building a "Knowledge Companion" tool. Powered by the <strong>Gemini API</strong> (using the Gemini Flash 1.5 model), this tool integrates directly into Salesforce to provide instant summaries of lengthy text content. This significantly enhances productivity by allowing users to grasp key information at a glance.</p>
            <h3>Real-Life Use Cases üí°</h3>
            <ul>
                <li><strong>Support Agents:</strong> Quickly summarize complex case histories or long knowledge articles to resolve issues faster.</li>
                <li><strong>Sales Teams:</strong> Get rapid summaries of account details, past communications, or opportunity notes.</li>
                <li><strong>Product Managers:</strong> Condense user feedback or technical documentation.</li>
                <li><strong>Any Salesforce User:</strong> Efficiently process information from lengthy text fields across various objects.</li>
            </ul>
        </div>

        <div class="slide" id="slide2">
            <h2>Lab Goal üéØ</h2>
            <p>By the end of this lab, you will have built a solution that can:</p>
            <ul>
                <li>Summarize content from a rich text area field (e.g., <code>Content_for_Summarization__c</code>) on a Salesforce Knowledge Article.</li>
                <li>Trigger this summarization process via a custom Lightning Web Component (LWC) button ("AI Summarise") placed on the Knowledge Article page.</li>
                <li>Display the AI-generated summary clearly within a modal dialog on the screen.</li>
            </ul>
            <p>This hands-on experience will cover Salesforce configuration, Apex development for API callouts, and LWC creation for a seamless user interface.</p>
        </div>

        <div class="slide" id="slide3">
            <h2>Step 1: Salesforce Org Setup ‚öôÔ∏è</h2>
            <p>First, let's prepare your Salesforce Developer Org.</p>
            <h3>1. Enable Salesforce Knowledge</h3>
            <ul>
                <li>Navigate to <strong>Setup</strong> &gt; <strong>Knowledge</strong> &gt; <strong>Knowledge Settings</strong>.</li>
                <li>If not already enabled, check "Yes, I'd like to enable Salesforce Knowledge" and follow the setup wizard. You might need to assign licenses and permissions to your user.</li>
            </ul>
            <h3>2. Add Custom Field to Knowledge Object</h3>
            <p>We need a field on the Knowledge Article object (API Name: <code>Knowledge__kav</code>) to hold the content you want to summarize. If you already have a rich text field with your main content, you can use that. Otherwise, create a new one:</p>
            <ul>
                <li>Navigate to <strong>Setup</strong> &gt; <strong>Object Manager</strong> &gt; <strong>Knowledge</strong>.</li>
                <li>Go to <strong>Fields & Relationships</strong> and click <strong>New</strong>.</li>
                <li>Select Data Type: <strong>Text Area (Rich)</strong> or <strong>Text Area (Long)</strong>. Click Next.</li>
                <li>Field Label: e.g., <code>Content for Summarization</code></li>
                <li>Field Name: e.g., <code>Content_for_Summarization__c</code>. (You will need this API name for the LWC later).</li>
                <li>Complete the field creation wizard (ensure it's visible to appropriate profiles and added to page layouts).</li>
            </ul>
            <div class="note">
                <strong>Important:</strong> Note down the API name of the field you intend to use for summarization (e.g., <code>Content_for_Summarization__c</code>, or a standard field like <code>Answer__c</code> if appropriate for your article type). You will need this for the LWC JavaScript.
            </div>
            <h3>3. API Access and User Permissions</h3>
            <ul>
                <li>Ensure your user profile has "API Enabled" system permission.</li>
                <li>Ensure your user has CRUD permissions on the Knowledge object and the custom field you're using.</li>
            </ul>
        </div>

        <div class="slide" id="slide4">
            <h2>Step 2: Gemini API Configuration üîë</h2>
            <p>Now, let's set up access to the Google Gemini API.</p>
            <h3>1. Get Your Gemini API Key</h3>
            <ul>
                <li>Go to <a href="https://makersuite.google.com/app/apikey" target="_blank">Google AI Studio</a>.</li>
                <li>Sign in with your Google account.</li>
                <li>Click on "Get API key" and then "Create API key in new project" (or use an existing one).</li>
                <li>Copy your API key. <strong>This key is sensitive! Store it securely and do not commit it directly into version control in real projects.</strong></li>
            </ul>
            <h3>2. Create a Named Credential in Salesforce</h3>
            <p>Named Credentials simplify authenticated callouts from Salesforce by separating the endpoint URL from the code.</p>
            <ul>
                <li>In Salesforce Setup, search for "Named Credentials".</li>
                <li>Click <strong>New Named Credential</strong>.
                    <ul>
                        <li><strong>Label:</strong> <code>Google_Gemini_API</code> (You can choose your own label)</li>
                        <li><strong>Name:</strong> <code>Google_Gemini_API</code> (Auto-filled from label, this is what you use in Apex: <code>callout:Google_Gemini_API</code>)</li>
                        <li><strong>URL:</strong> <code>https://generativelanguage.googleapis.com</code> (This is the base URL for the Gemini API)</li>
                        <li><strong>Identity Type:</strong> <code>Anonymous</code> (As we'll pass the API key in the header via Apex)</li>
                        <li><strong>Authentication Protocol:</strong> <code>No Authentication</code></li>
                        <li><strong>Generate Authorization Header:</strong> Unchecked</li>
                    </ul>
                </li>
                <li>Click <strong>Save</strong>.</li>
            </ul>
            <h3>3. Securely Storing and Accessing the API Key (POC vs. Production)</h3>
            <div class="note">
                <p>For this POC / Lab: We'll show how to place the API key in Apex with a clear placeholder. This is for ease of setup during the lab.</p>
                <p><strong>For Production (and better practice even for POCs):</strong></p>
                <ol>
                    <li>Store the API Key in a **Protected Custom Setting** or **Protected Custom Metadata Type**. This keeps it out of code.</li>
                    <li>Retrieve it in Apex: e.g., <code>My_API_Keys__c.getInstance('Gemini').API_Key__c;</code></li>
                </ol>
                <p>Hardcoding keys directly in Apex is a security risk in real-world applications.</p>
            </div>
        </div>

        <div class="slide" id="slide5">
            <h2>Step 3: Apex Code Walkthrough üë®‚Äçüíª</h2>
            <p>This Apex class (<code>GeminiAPIService.cls</code>) will make the callout to the Gemini API. Create this class in your Salesforce org.</p>
            <p><strong>Important:</strong> The code below is for direct copy-pasting. Replace the placeholder API key with your actual key.</p>
            <pre><code class="language-apex">
// File: GeminiAPIService.cls
// Purpose: Service class to interact with the Google Gemini API for text summarization.
public with sharing class GeminiAPIService {

    // Retrieves the Gemini API Key.
    // FOR LAB PURPOSES: Replace the placeholder string with your actual API key.
    // IN PRODUCTION: Use a secure mechanism like Protected Custom Settings/Metadata.
    private static String getApiKey() {
        // TODO: LAB PARTICIPANT - REPLACE 'YOUR_ACTUAL_GEMINI_API_KEY_HERE' WITH YOUR KEY
        String apiKey = 'YOUR_ACTUAL_GEMINI_API_KEY_HERE'; 

        // Basic check to remind user if placeholder is still there
        if (String.isBlank(apiKey) || apiKey == 'YOUR_ACTUAL_GEMINI_API_KEY_HERE') {
            System.debug(LoggingLevel.ERROR, 'GeminiAPIService.getApiKey(): API Key is missing or is still the placeholder. Please update it.');
        }
        return apiKey;
    }

    // Method callable from LWC to get a summary for the given text.
    @AuraEnabled(cacheable=false) // cacheable=false because it performs an HTTP callout
    public static String getPageSummaryFromGemini(String htmlText) {
        // Use the specific method name from your provided Apex: getPageSummaryFromGemini
        // If using the original lab context, it was getSummary(Id recordId, String textToSummarize)
        // For this example, we'll stick to the method name from your provided Apex: getPageSummaryFromGemini

        String textToSummarize = htmlText; // Assuming htmlText is the text to summarize

        if (String.isBlank(textToSummarize)) {
            System.debug('GeminiAPIService.getPageSummaryFromGemini: Input text was blank.');
            return 'Error: Input text for summarization is blank.';
        }
        
        // Your provided Apex uses a direct endpoint construction.
        // If using Named Credentials (recommended, as set up in Slide 4), the endpoint would be:
        // String endpoint = 'callout:Google_Gemini_API/v1beta/models/gemini-1.5-flash:generateContent';
        // And the API key would be added via request.setHeader('x-goog-api-key', GEMINI_API_KEY);
        // The code you provided uses a different structure (direct endpoint with key in URL).
        // We will adapt to use the Named Credential setup from Slide 4 for consistency and best practice.

        String GEMINI_API_KEY = getApiKey(); // Get the API key

        if (String.isBlank(GEMINI_API_KEY) || GEMINI_API_KEY == 'YOUR_ACTUAL_GEMINI_API_KEY_HERE') {
            return 'Error: Gemini API Key is not configured in Apex. Please update GeminiAPIService.cls.';
        }

        // Using Named Credential (as per Slide 4 setup)
        String endpoint = 'callout:Google_Gemini_API/v1beta/models/gemini-1.5-flash:generateContent';

        // Gemini API requires a specific prompt structure for summarization.
        // The prompt you provided in your Apex code is good for page content.
        String prompt = 'You are an AI assistant trained to summarize web content into a short, well-structured, HTML-formatted summary. ' +
            'The input includes raw visible text from an internal Salesforce Experience Cloud page. ' +
            'Please ignore navigation menus, headers, footers, search bars, and unrelated UI text. ' +
            'Focus only on meaningful main content such as policy text, announcements, structured descriptions, and business explanations.\n\n' +
            'Provide your output in HTML format using bullet points (i.e., use &lt;ul&gt;&lt;li&gt;...&lt;/li&gt;&lt;/ul&gt;) when possible. ' +
            'Avoid repeating text or adding boilerplate language.\n\n' +
            'Here is the extracted page text:\n\n' + textToSummarize;

        // Build JSON payload as per Gemini API requirements
        Map&lt;String, Object&gt; requestBody = new Map&lt;String, Object&gt;{
            'contents' => new List&lt;Object&gt;{
                new Map&lt;String, Object&gt;{
                    'parts' => new List&lt;Object&gt;{
                        new Map&lt;String, Object&gt;{
                            'text' => prompt
                        }
                    }
                }
            }
            // Optional: Add 'generationConfig' here if needed
            // 'generationConfig': new Map<String, Object> {
            //    'maxOutputTokens' => 250, // Example
            //    'temperature' => 0.7      // Example
            // }
        };

        // Prepare HTTP callout
        HttpRequest req = new HttpRequest();
        req.setEndpoint(endpoint); // Using Named Credential
        req.setMethod('POST');
        req.setHeader('Content-Type', 'application/json; charset=utf-8');
        req.setHeader('x-goog-api-key', GEMINI_API_KEY); // API key in header
        req.setTimeout(60000); // 60 seconds timeout
        req.setBody(JSON.serialize(requestBody));

        Http http = new Http();
        String summaryResult = '';

        try {
            HttpResponse res = http.send(req);
            System.debug('Gemini API Callout Status: ' + res.getStatusCode() + ', Body: ' + res.getBody());

            if (res.getStatusCode() == 200) {
                Map&lt;String, Object&gt; jsonResponse = (Map&lt;String, Object&gt;) JSON.deserializeUntyped(res.getBody());
                List&lt;Object&gt; candidates = (List&lt;Object&gt;) jsonResponse.get('candidates');
                
                if (candidates != null && !candidates.isEmpty()) {
                    Map&lt;String, Object&gt; firstCandidate = (Map&lt;String, Object&gt;) candidates[0];
                    Map&lt;String, Object&gt; content = (Map&lt;String, Object&gt;) firstCandidate.get('content');
                    if (content != null) {
                        List&lt;Object&gt; parts = (List&lt;Object&gt;) content.get('parts');
                        if (parts != null && !parts.isEmpty()) {
                            Map&lt;String, Object&gt; part = (Map&lt;String, Object&gt;) parts[0];
                            summaryResult = (String) part.get('text');
                        } else { summaryResult = 'Error: No "parts" in API response content.'; }
                    } else { summaryResult = 'Error: No "content" in API response candidate.'; }
                } else { 
                    summaryResult = 'Error: No "candidates" in API response.';
                    if (jsonResponse.containsKey('error')) {
                        Map&lt;String, Object&gt; errorDetails = (Map&lt;String, Object&gt;)jsonResponse.get('error');
                        summaryResult += ' API Error: ' + String.valueOf(errorDetails.get('message'));
                    }
                }
            } else {
                summaryResult = 'Error from Gemini API: Status ' + res.getStatusCode() + '. Response: ' + res.getBody();
            }
        } catch (System.CalloutException cex) {
            summaryResult = 'Error: Callout exception - ' + cex.getMessage();
            System.debug(LoggingLevel.ERROR, 'GeminiAPIService CalloutException: ' + cex.getMessage() + '\\n' + cex.getStackTraceString());
        } catch (Exception ex) {
            summaryResult = 'Error: Exception during Gemini API callout - ' + ex.getMessage();
            System.debug(LoggingLevel.ERROR, 'GeminiAPIService Generic Exception: ' + ex.getMessage() + '\\n' + ex.getStackTraceString());
        }
        return summaryResult;
    }
}
</code></pre>
            <div class="note">
                <strong>Action:</strong>
                <ol>
                    <li>Copy the Apex code above.</li>
                    <li>In Salesforce Setup, go to Developer Console and create a new Apex Class named <code>GeminiAPIService</code>.</li>
                    <li>Paste the code and **replace <code>'YOUR_ACTUAL_GEMINI_API_KEY_HERE'</code>** with your valid Gemini API Key.</li>
                    <li>Save the class.</li>
                </ol>
            </div>
        </div>

        <div class="slide" id="slide6">
            <h2>Step 4: Lightning Web Component (LWC) ‚ö°</h2>
            <p>Create an LWC named <code>knowledgeCompanion</code> (or similar). It will consist of three files.
            The LWC code you provided takes the entire `document.documentElement.outerText`. For a Knowledge Article context, it's usually better to target a specific field from the record. I'll provide code aligned with the original lab goal (summarizing a field), but will also include notes on your `outerText` approach if you prefer it for a different use case.</p>

            <h3>Version A: Summarizing a Specific Field (Original Lab Goal)</h3>
            <p>This version assumes the LWC is on a Knowledge Article record page and summarizes a specific field like <code>Content_for_Summarization__c</code>.</p>

            <h4>1. <code>knowledgeCompanion.html</code></h4>
            <pre><code class="language-html">
&lt;!-- File: knowledgeCompanion.html --&gt;
&lt;template&gt;
    &lt;lightning-card title="Knowledge Article Summarizer" icon-name="utility:summarydetail"&gt;
        &lt;div class="slds-p-around_medium"&gt;
            &lt;lightning-button
                label="Summarise Article Content"
                variant="brand"
                onclick={handleSummarizeArticleField}
                disabled={isLoading}
                icon-name="utility:magicwand"&gt;
            &lt;/lightning-button&gt;

            &lt;template if:true={isLoading}&gt;
                &lt;div class="slds-m-top_medium slds-is-relative" style="height: 50px;"&gt;
                    &lt;lightning-spinner alternative-text="Loading summary..." size="medium"&gt;&lt;/lightning-spinner&gt;
                &lt;/div&gt;
            &lt;/template&gt;

            &lt;template if:true={error}&gt;
                &lt;div class="slds-m-top_medium slds-text-color_error"&gt;
                    &lt;p&gt;&lt;strong&gt;Error:&lt;/strong&gt; {error}&lt;/p&gt;
                &lt;/div&gt;
            &lt;/template&gt;
        &lt;/div&gt;
    &lt;/lightning-card&gt;

    &lt;template if:true={isModalOpen}&gt;
        &lt;section role="dialog" tabindex="-1" aria-modal="true" class="slds-modal slds-fade-in-open"&gt;
            &lt;div class="slds-modal__container"&gt;
                &lt;header class="slds-modal__header"&gt;
                    &lt;button class="slds-button slds-button_icon slds-modal__close slds-button_icon-inverse" title="Close" onclick={closeModal}&gt;
                        &lt;lightning-icon icon-name="utility:close" alternative-text="Close" variant="inverse" size="small"&gt;&lt;/lightning-icon&gt;
                        &lt;span class="slds-assistive-text"&gt;Close&lt;/span&gt;
                    &lt;/button&gt;
                    &lt;h2 class="slds-modal__title slds-hyphenate"&gt;Article Summary&lt;/h2&gt;
                &lt;/header&gt;
                &lt;div class="slds-modal__content slds-p-around_medium"&gt;
                    &lt;lightning-formatted-rich-text value={summaryText}&gt;&lt;/lightning-formatted-rich-text&gt;
                &lt;/div&gt;
                &lt;footer class="slds-modal__footer"&gt;
                    &lt;lightning-button label="Close" title="Close" onclick={closeModal}&gt;&lt;/lightning-button&gt;
                &lt;/footer&gt;
            &lt;/div&gt;
        &lt;/section&gt;
        &lt;div class="slds-backdrop slds-backdrop_open" role="presentation"&gt;&lt;/div&gt;
    &lt;/template&gt;
&lt;/template&gt;
            </code></pre>

            <h4>2. <code>knowledgeCompanion.js</code></h4>
            <pre><code class="language-javascript">
// File: knowledgeCompanion.js (Version A: Summarizing a specific field)
import { LightningElement, api, wire, track } from 'lwc';
import { getRecord, getFieldValue } from 'lightning/uiRecordApi';
import getPageSummaryFromGemini from '@salesforce/apex/GeminiAPIService.getPageSummaryFromGemini'; // Using the Apex method name you provided

// --- IMPORTANT: Field API Name to Summarize ---
// TODO: LAB PARTICIPANT - Update this import to point to the API name of the 
// rich text field on YOUR Knowledge__kav object that you want to summarize.
// Example: import KNOWLEDGE_CONTENT_FIELD from '@salesforce/schema/Knowledge__kav.MyCustomBody__c';
import KNOWLEDGE_CONTENT_FIELD from '@salesforce/schema/Knowledge__kav.Content_for_Summarization__c'; 

export default class KnowledgeCompanion extends LightningElement {
    @api recordId; // Automatically gets the ID of the record page

    @track summaryText = '';
    @track isLoading = false;
    @track error;
    @track isModalOpen = false;
    _wiredArticleData;

    // Wire service to fetch the content of the specified field
    @wire(getRecord, { recordId: '$recordId', fields: [KNOWLEDGE_CONTENT_FIELD] })
    wiredArticle({ error, data }) {
        if (data) {
            this._wiredArticleData = data;
            this.error = undefined;
        } else if (error) {
            console.error('LWC Error - Failed to load article content via @wire:', JSON.stringify(error));
            this.error = 'Failed to load article content. Check field API name & permissions.';
            this._wiredArticleData = undefined;
        }
    }

    get articleContent() {
        if (this._wiredArticleData) {
            return getFieldValue(this._wiredArticleData, KNOWLEDGE_CONTENT_FIELD);
        }
        return undefined;
    }

    async handleSummarizeArticleField() {
        this.isLoading = true;
        this.error = undefined;
        this.summaryText = '';

        const contentValue = this.articleContent;

        if (!contentValue || String(contentValue).trim() === '') {
            this.error = \`The field '\${KNOWLEDGE_CONTENT_FIELD.fieldApiName}' is empty or no text to summarize.\`;
            this.isLoading = false;
            return;
        }
        
        let plainTextContent = this.stripHtml(String(contentValue));
        if (!plainTextContent || plainTextContent.trim() === '') {
            this.error = 'Content empty after HTML stripping.';
            this.isLoading = false;
            return;
        }

        try {
            const result = await getPageSummaryFromGemini({ htmlText: plainTextContent }); // Passing content as 'htmlText'
            
            if (result) {
                if (result.toLowerCase().startsWith('error:')) {
                    this.error = result;
                } else {
                    // The prompt asks for HTML, so lightning-formatted-rich-text is good.
                    this.summaryText = result; 
                    this.isModalOpen = true;
                }
            } else {
                this.error = 'Empty response from summarization service.';
            }
        } catch (e) {
            console.error('LWC Error - Calling Apex:', JSON.stringify(e));
            this.error = 'Error getting summary: ' + (e.body?.message || e.message);
        } finally {
            this.isLoading = false;
        }
    }
    
    stripHtml(html) {
        if (!html) return "";
        try {
            let doc = new DOMParser().parseFromString(html, 'text/html');
            return doc.body.textContent || "";
        } catch (e) {
            return html.replace(/<[^>]*>?/gm, '');
        }
    }

    closeModal() {
        this.isModalOpen = false;
        this.summaryText = '';
    }
}
            </code></pre>

            <h4>3. <code>knowledgeCompanion.js-meta.xml</code></h4>
            <pre><code class="language-xml">
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;LightningComponentBundle xmlns="http://soap.sforce.com/2006/04/metadata"&gt;
    &lt;apiVersion&gt;59.0&lt;/apiVersion&gt; 
    &lt;isExposed&gt;true&lt;/isExposed&gt;
    &lt;targets&gt;
        &lt;target&gt;lightning__RecordPage&lt;/target&gt;
    &lt;/targets&gt;
    &lt;targetConfigs&gt;
        &lt;targetConfig targets="lightning__RecordPage"&gt;
            &lt;objects&gt;
                &lt;object&gt;Knowledge__kav&lt;/object&gt;
            &lt;/objects&gt;
        &lt;/targetConfig&gt;
    &lt;/targetConfigs&gt;
&lt;/LightningComponentBundle&gt;
            </code></pre>
            <div class="note">
                <strong>To use Version A:</strong>
                <ol>
                    <li>Ensure the Apex class <code>GeminiAPIService</code> is created with the method <code>getPageSummaryFromGemini(String htmlText)</code>.</li>
                    <li>Create the LWC `knowledgeCompanion` with the HTML, JS (Version A), and XML files above.</li>
                    <li>**Crucially, update the `KNOWLEDGE_CONTENT_FIELD` import in `knowledgeCompanion.js`** to your specific Knowledge Article field.</li>
                    <li>Deploy the Apex class and LWC.</li>
                    <li>Add the LWC to a Knowledge Article record page.</li>
                </ol>
            </div>

            <hr style="margin: 2em 0;">
            <h3>Version B: Summarizing `document.documentElement.outerText` (Based on your provided LWC JS)</h3>
            <p>This version attempts to summarize the entire visible text of the current browser page. This is a different approach and might be useful for summarizing Experience Cloud pages or other general web pages where the LWC is placed, but it's less targeted than summarizing a specific field and might grab irrelevant text.</p>
            <p><strong>If you prefer this approach, you would use the Apex class from Slide 5 and the LWC `knowledgeCompanion.js-meta.xml` (modified for relevant targets like `lightningCommunity__Page`) along with the following LWC HTML and JS:</strong></p>

            <h4>1. <code>knowledgeCompanion.html</code> (for Version B)</h4>
            <pre><code class="language-html">
&lt;!-- File: knowledgeCompanion.html (for Version B - full page text) --&gt;
&lt;template&gt;
    &lt;div class="slds-p-around_medium"&gt;
        &lt;lightning-button
            label="AI Summarise This Page"
            onclick={handleSummarizeCurrentPageText}
            class="slds-m-bottom_medium"
            variant="brand"
            disabled={isLoading}&gt;
        &lt;/lightning-button&gt;
    &lt;/div&gt;
    &lt;template if:true={isLoading}&gt;
        &lt;div class="slds-m-around_medium"&gt;
            &lt;lightning-spinner alternative-text="Summarising page..." size="medium"&gt;&lt;/lightning-spinner&gt;
        &lt;/div&gt;
    &lt;/template&gt;
    &lt;template if:true={error}&gt;
         &lt;div class="slds-m-around_medium slds-text-color_error"&gt;
            &lt;p&gt;&lt;strong&gt;Error:&lt;/strong&gt; {error}&lt;/p&gt;
        &lt;/div&gt;
    &lt;/template&gt;
    &lt;template if:true={isModalOpen}&gt;
        &lt;section role="dialog" tabindex="-1" aria-modal="true" class="slds-modal slds-fade-in-open"&gt;
            &lt;div class="slds-modal__container"&gt;
                &lt;header class="slds-modal__header"&gt;
                    &lt;button class="slds-button slds-button_icon slds-modal__close slds-button_icon-inverse" title="Close" onclick={closeModal}&gt;
                        &lt;lightning-icon icon-name="utility:close" alternative-text="Close" variant="inverse" size="small"&gt;&lt;/lightning-icon&gt;
                    &lt;/button&gt;
                    &lt;h2 class="slds-modal__title slds-hyphenate"&gt;Page Summary&lt;/h2&gt;
                &lt;/header&gt;
                &lt;div class="slds-modal__content slds-p-around_medium"&gt;
                    &lt;lightning-formatted-rich-text value={summaryText}&gt;&lt;/lightning-formatted-rich-text&gt;
                &lt;/div&gt;
                &lt;footer class="slds-modal__footer"&gt;
                    &lt;lightning-button label="Close" onclick={closeModal}&gt;&lt;/lightning-button&gt;
                &lt;/footer&gt;
            &lt;/div&gt;
        &lt;/section&gt;
        &lt;div class="slds-backdrop slds-backdrop_open"&gt;&lt;/div&gt;
    &lt;/template&gt;
&lt;/template&gt;
            </code></pre>
            <h4>2. <code>knowledgeCompanion.js</code> (for Version B)</h4>
            <pre><code class="language-javascript">
// File: knowledgeCompanion.js (Version B: Summarizing document.documentElement.outerText)
import { LightningElement, track } from 'lwc';
import getPageSummaryFromGemini from '@salesforce/apex/GeminiAPIService.getPageSummaryFromGemini';

export default class KnowledgeCompanionPageSummarizer extends LightningElement {
    @track summaryText = '';
    @track isLoading = false;
    @track error;
    @track isModalOpen = false;

    async handleSummarizeCurrentPageText() {
        this.isLoading = true;
        this.error = undefined;
        this.summaryText = '';
        console.log('Attempting to summarize current page text...');

        // Get all visible text from the current page.
        // This can be a lot of text and might include irrelevant UI elements.
        const mainContent = document.documentElement.outerText || '';

        if (!mainContent || mainContent.trim().length < 100) { // Basic check for minimum content
            this.error = 'Page content is too short or could not be extracted for summarization.';
            this.isLoading = false;
            alert(this.error); // Simple alert for user feedback
            return;
        }

        // The prompt in Apex is designed to help Gemini focus on main content.
        try {
            const result = await getPageSummaryFromGemini({ htmlText: mainContent }); // htmlText is the parameter name in Apex
            
            if (result) {
                if (result.toLowerCase().startsWith('error:')) {
                    this.error = result;
                    console.error('Error from Apex (page summarization):', result);
                } else {
                    // The Apex prompt asks for HTML, so lightning-formatted-rich-text is appropriate.
                    // You might need to clean up markdown-like formatting if Gemini returns it.
                    const cleanedResult = result.replace(/```html/g, '').replace(/```/g, '').trim();
                    this.summaryText = cleanedResult;
                    this.isModalOpen = true;
                }
            } else {
                this.error = 'Empty response from page summarization service.';
            }
        } catch (e) {
            console.error('LWC Error - Calling Apex for page summarization:', JSON.stringify(e));
            this.error = 'Error during page summarization: ' + (e.body?.message || e.message);
        } finally {
            this.isLoading = false;
        }
    }

    closeModal() {
        this.isModalOpen = false;
        this.summaryText = '';
    }
}
            </code></pre>
        </div>

        <div class="slide" id="slide7">
            <h2>Step 5: Simulation & Visuals üìä</h2>
            <h3>Workflow Animation</h3>
            <p>This D3.js animation visualizes the data flow when you click "AI Summarise". Click "Replay Animation" to restart it.</p>
            <div id="workflowAnimation"></div>
            <button onclick="startWorkflowAnimation()" class="slds-button slds-button_neutral slds-m-top_small">Replay Animation</button>

            <h3 class="slds-m-top_large">Before/After Summary View (Toggle Example)</h3>
            <div class="summary-toggle-container">
                <p>This is a static example to simulate how long text can be condensed. Click the button to toggle between the original content and its AI-generated summary.</p>
                <button id="toggleSummaryBtn" onclick="toggleSummaryView()" class="slds-button slds-button_brand">Show AI Summary Example</button>
                <div id="originalTextView" class="summary-text-area">
                    <h4>Original Document Text (Example)</h4>
                    <p>The Q4 Global Sales Initiative, codenamed "Project Everest," aims to expand market penetration in emerging APAC regions by 15% and increase overall recurring revenue by 10% through strategic partnerships and a revamped digital marketing strategy. Key performance indicators (KPIs) will include new customer acquisition rates, average deal size, and customer lifetime value. The initiative will involve cross-functional teams from Sales, Marketing, and Product Development, with a projected timeline of six months, starting January 1st. Bi-weekly progress reports will be submitted to the executive leadership team, outlining achievements, challenges, and mitigation strategies. A dedicated budget of $2.5 million has been allocated for this initiative, covering marketing campaigns, sales incentives, and technology upgrades. Training sessions for the sales team on new product features and market positioning are scheduled for mid-December. The success of Project Everest is critical for achieving the company's annual growth targets and strengthening its competitive position in the global market. All team members are expected to fully commit to their roles and responsibilities to ensure the project's objectives are met within the stipulated timeframe and budget.</p>
                </div>
                <div id="summaryAfterView" class="summary-text-area">
                    <h4>AI Generated Summary (Example)</h4>
                    <p>"Project Everest," a 6-month, $2.5M Q4 initiative, targets a 15% APAC market expansion and 10% recurring revenue growth via partnerships and digital marketing. KPIs include customer acquisition, deal size, and lifetime value. Cross-functional teams will report bi-weekly to executives. Success is vital for annual growth and market position.</p>
                </div>
            </div>
        </div>

        <div class="slide" id="slide8">
            <h2>Congratulations & Next Steps üéâ</h2>
            <h3>What You've Accomplished in this Lab üèÜ</h3>
            <ul>
                <li>Configured Salesforce and the Gemini API for integration.</li>
                <li>Developed an Apex class to make secure callouts to an external AI service.</li>
                <li>Built a Lightning Web Component (LWC) to provide a user interface on a record page.</li>
                <li>Implemented LWC-to-Apex communication to trigger the AI summarization.</li>
                <li>Displayed dynamic results from an API call within a modal in the LWC.</li>
                <li>Understood the basic principles of consuming generative AI for text summarization within Salesforce.</li>
            </ul>
            <h3>Potential Project Implementations & Enhancements üöÄ</h3>
            <ul>
                <li>Summarize Case descriptions, EmailMessage bodies, Account notes, or Chatter posts.</li>
                <li>Implement batch Apex to summarize multiple records asynchronously.</li>
                <li>Allow users to customize the summarization prompt sent to the Gemini API.</li>
                <li>Extend to other generative AI tasks: text generation, translation, sentiment analysis.</li>
                <li>Option to save the generated summary back to a field on the Salesforce record.</li>
                <li>Trigger summarization via Salesforce Flow or Process Builder (using invocable Apex).</li>
            </ul>
            <h3>Further Reading & Resources üìö</h3>
            <ul>
                <li><a href="https://ai.google.dev/docs/gemini_api_overview" target="_blank">Google Gemini API Documentation</a></li>
                <li><a href="https://developer.salesforce.com/docs/" target="_blank">Salesforce Developer Guide</a></li>
                <li><a href="https://developer.salesforce.com/docs/component-library/documentation/en/lwc" target="_blank">Lightning Web Components Dev Guide</a></li>
                <li>Trailhead: Search for "Apex Integration Services", "Lightning Web Components Basics", "Build Flows with Invocable Actions".</li>
            </ul>
            <p>Keep exploring, keep building, and happy coding!</p>
        </div>
    </div> <div class="navigation-buttons">
        <button id="prevBtn" onclick="changeSlide(-1)">‚ùÆ Previous</button>
        <button id="nextBtn" onclick="changeSlide(1)">Next ‚ùØ</button>
    </div>

    <script>
        // --- Slide Navigation Logic ---
        let currentSlide = 0;
        const slides = document.querySelectorAll('.slide');
        const totalSlides = slides.length;
        const prevButton = document.getElementById('prevBtn');
        const nextButton = document.getElementById('nextBtn');

        function showSlide(index) {
            if (!slides || slides.length === 0) {
                console.error("Slides not found. Navigation cannot work.");
                return;
            }
            if (index < 0 || index >= totalSlides) {
                console.error("Invalid slide index:", index);
                return;
            }
            slides.forEach((slideEl, i) => {
                slideEl.classList.remove('active');
                if (i === index) {
                    slideEl.classList.add('active');
                }
            });
            currentSlide = index;
            updateNavButtons();

            if (index === 6) { // Slide 7 (0-indexed for workflow animation)
                startWorkflowAnimation();
            }
        }

        function changeSlide(step) {
            let newSlideIndex = currentSlide + step;
            // Bounds check is implicitly handled by showSlide, 
            // but good to ensure newSlideIndex is valid before calling.
            if (newSlideIndex >= 0 && newSlideIndex < totalSlides) {
                showSlide(newSlideIndex);
            }
        }
        
        function updateNavButtons() {
            if (prevButton) {
                prevButton.disabled = (currentSlide === 0);
            }
            if (nextButton) {
                nextButton.disabled = (currentSlide === totalSlides - 1);
            }
        }

        // --- Initialization on DOMContentLoaded ---
        document.addEventListener('DOMContentLoaded', () => {
            // Check if slide elements and buttons exist before trying to use them
            if (slides.length > 0) {
                if (prevButton && nextButton) {
                    showSlide(0); // Initialize first slide and button states
                } else {
                    console.error("Navigation buttons not found. Navigation will be disabled.");
                }
            } else {
                console.error("No slides with class '.slide' found. Navigation will not work.");
                if(prevButton) prevButton.disabled = true;
                if(nextButton) nextButton.disabled = true;
            }
            
            // Initialize toggle button text for summary example
            const toggleBtn = document.getElementById('toggleSummaryBtn');
            const summaryView = document.getElementById('summaryAfterView');
            if (toggleBtn && summaryView) {
                 if (summaryView.style.display === 'none' || summaryView.style.display === '') {
                    toggleBtn.textContent = 'Show AI Summary Example';
                } else {
                    toggleBtn.textContent = 'Show Original Text';
                }
            }
            // Syntax highlighting is removed as per user request for plain code blocks
        });

        // --- Slide 7: D3.js Workflow Animation ---
        function startWorkflowAnimation() {
            const svgContainer = d3.select("#workflowAnimation");
            svgContainer.selectAll("*").remove(); 

            const bounds = svgContainer.node()?.getBoundingClientRect(); // Optional chaining for robustness
            if (!bounds || bounds.width <= 0 || bounds.height <= 0) {
                console.warn("D3 container has no valid dimensions. Skipping animation.");
                return;
            }
            const width = bounds.width;
            const height = bounds.height;
            
            const svg = svgContainer.append("svg")
                .attr("width", width)
                .attr("height", height)
                .attr("viewBox", `0 0 ${width} ${height}`)
                .style("overflow", "visible");

            const nodeRadius = Math.min(width, height) * 0.05;
            const fontSize = Math.min(width, height) * 0.025;

            const nodesData = [ // Renamed to avoid conflict with 'nodes' variable if it exists elsewhere
                { id: 1, name: "User Clicks Summarise", x: width * 0.2, y: height * 0.3 },
                { id: 2, name: "Apex Callout", x: width * 0.4, y: height * 0.3 },
                { id: 3, name: "SF Sends Request", x: width * 0.5, y: height * 0.15 },
                { id: 4, name: "Gemini API Processes", x: width * 0.7, y: height * 0.15 },
                { id: 5, name: "Gemini Responds", x: width * 0.5, y: height * 0.85 },
                { id: 6, name: "Apex Receives", x: width * 0.4, y: height * 0.7 },
                { id: 7, name: "Summary Displayed", x: width * 0.2, y: height * 0.7 }
            ];

            const linksData = [ // Renamed
                { source: nodesData[0], target: nodesData[1], label: "1. UI Event" },
                { source: nodesData[1], target: nodesData[2], label: "2. To SF Server" },
                { source: nodesData[2], target: nodesData[3], label: "3. To Gemini" },
                { source: nodesData[3], target: nodesData[4], label: "4. AI Response" },
                { source: nodesData[4], target: nodesData[5], label: "5. Back to SF" },
                { source: nodesData[5], target: nodesData[6], label: "6. Update UI" }
            ];
            
            svg.append("defs").append("marker")
                .attr("id", "arrow")
                .attr("viewBox", "0 -5 10 10")
                .attr("refX", nodeRadius * 0.7 + 5) 
                .attr("refY", 0)
                .attr("markerWidth", 6)
                .attr("markerHeight", 6)
                .attr("orient", "auto-start-reverse")
              .append("path")
                .attr("d", "M0,-5L10,0L0,5")
                .style("fill", "#555");

            const nodeElements = svg.selectAll("g.node")
                .data(nodesData) // Use renamed data variable
                .enter().append("g")
                .attr("class", "node")
                .attr("transform", d => `translate(${d.x},${d.y})`);

            nodeElements.append("circle")
                .attr("r", nodeRadius)
                .style("fill", "#00A1E0")
                .style("stroke", "#0070D2")
                .style("stroke-width", 2);

            nodeElements.append("text")
                .text(d => d.name)
                .attr("x", 0) 
                .attr("y", nodeRadius + fontSize * 1.2) 
                .style("font-size", `${fontSize}px`)
                .style("fill", "#333")
                .style("text-anchor", "middle");

            let animationDelay = 0;
            const stepDuration = 1000; 
            const highlightDuration = 500;

            linksData.forEach((link, i) => { // Use renamed data variable
                const path = svg.append("line")
                    .attr("x1", link.source.x).attr("y1", link.source.y)
                    .attr("x2", link.source.x).attr("y2", link.source.y)
                    .attr("stroke", "#aaa").attr("stroke-width", 2)
                    .attr("marker-end", "url(#arrow)");
                
                const label = svg.append("text")
                    .text(link.label)
                    .attr("x", (link.source.x + link.target.x) / 2)
                    .attr("y", (link.source.y + link.target.y) / 2 - 5)
                    .style("font-size", `${fontSize * 0.8}px`).style("fill", "#555")
                    .style("text-anchor", "middle").style("opacity", 0);

                d3.select(nodeElements.nodes()[i]).select("circle").transition()
                    .delay(animationDelay).duration(highlightDuration).style("fill", "orange");
                animationDelay += highlightDuration;

                path.transition().delay(animationDelay).duration(stepDuration)
                    .attr("x2", link.target.x).attr("y2", link.target.y);

                label.transition().delay(animationDelay + stepDuration / 2).duration(highlightDuration)
                    .style("opacity", 1);
                animationDelay += stepDuration;

                d3.select(nodeElements.nodes()[i]).select("circle").transition()
                    .delay(animationDelay).duration(highlightDuration).style("fill", "#5cb85c");
            });
            
            if (nodesData.length > 0 && nodeElements.nodes()[nodesData.length-1]) { 
                 d3.select(nodeElements.nodes()[nodesData.length-1]).select("circle").transition()
                    .delay(animationDelay).duration(highlightDuration).style("fill", "#5cb85c");
            }
        }
        
        // --- Slide 7: Before/After Toggle Logic ---
        function toggleSummaryView() {
            const originalView = document.getElementById('originalTextView');
            const summaryView = document.getElementById('summaryAfterView');
            const button = document.getElementById('toggleSummaryBtn');

            if (summaryView && originalView && button) {
                if (summaryView.style.display === 'none' || summaryView.style.display === '') {
                    originalView.style.display = 'none';
                    summaryView.style.display = 'block';
                    button.textContent = 'Show Original Text';
                } else {
                    originalView.style.display = 'block';
                    summaryView.style.display = 'none';
                    button.textContent = 'Show AI Summary Example';
                }
            } else {
                console.error("Summary toggle elements not found.");
            }
        }
        // Syntax highlighting function is removed. Code will be plain text in <pre><code> blocks.
    </script>
</body>
</html>
